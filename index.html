<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme Ratours</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // ==================== CONFIGURATION ====================
        const GOOGLE_CONFIG = {
            CLIENT_ID: '988519105715-eqfihmrhgotpkund2ub9nvb3ov7nfde4.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets'
        };
        
        // Ic√¥nes simplifi√©es
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                home: "üè†", calendar: "üìÖ", check: "‚úì", cart: "üõí", 
                chef: "üçΩÔ∏è", users: "üë®‚Äçüë©‚Äçüëß", logout: "‚Üí", settings: "‚öôÔ∏è",
                chart: "üìä", baby: "üë∂", plus: "+", x: "√ó",
                edit: "‚úèÔ∏è", save: "üíæ", trash: "üóëÔ∏è", left: "‚Üê", right: "‚Üí",
                sync: "üîÑ", cloud: "‚òÅÔ∏è", magic: "‚ú®"
            };
            return <span className={className} style={{ fontSize: size }}>{icons[name] || "‚Ä¢"}</span>;
        };

        // ==================== GOOGLE SHEETS API ====================
        class GoogleSheetsService {
            constructor() {
                this.accessToken = null;
                this.tokenClient = null;
                this.isInitialized = false;
                this.spreadsheetId = localStorage.getItem('spreadsheet_id') || null;
            }

            initialize() {
                return new Promise((resolve) => {
                    if (this.isInitialized) {
                        resolve(true);
                        return;
                    }

                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CONFIG.CLIENT_ID,
                        scope: GOOGLE_CONFIG.SCOPES,
                        callback: (response) => {
                            if (response.access_token) {
                                this.accessToken = response.access_token;
                                localStorage.setItem('gsheets_token', response.access_token);
                            }
                        },
                    });
                    
                    this.isInitialized = true;
                    
                    const savedToken = localStorage.getItem('gsheets_token');
                    if (savedToken) {
                        this.accessToken = savedToken;
                    }
                    
                    resolve(true);
                });
            }

            async requestAuth() {
                return new Promise((resolve) => {
                    this.tokenClient.callback = (response) => {
                        if (response.access_token) {
                            this.accessToken = response.access_token;
                            localStorage.setItem('gsheets_token', response.access_token);
                            resolve(true);
                        } else {
                            resolve(false);
                        }
                    };
                    this.tokenClient.requestAccessToken();
                });
            }

            isAuthenticated() {
                return !!this.accessToken;
            }

            hasSpreadsheet() {
                return !!this.spreadsheetId;
            }

            logout() {
                this.accessToken = null;
                this.spreadsheetId = null;
                localStorage.removeItem('gsheets_token');
                localStorage.removeItem('spreadsheet_id');
            }

            async createSpreadsheet() {
                try {
                    const response = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            properties: {
                                title: 'Plateforme Ratours Data'
                            },
                            sheets: [
                                { properties: { title: 'users' } },
                                { properties: { title: 'events' } },
                                { properties: { title: 'todos' } },
                                { properties: { title: 'courses' } },
                                { properties: { title: 'menus' } },
                                { properties: { title: 'guardSchedule' } },
                                { properties: { title: 'familyInfo' } }
                            ]
                        })
                    });

                    if (!response.ok) throw new Error('Failed to create spreadsheet');
                    
                    const data = await response.json();
                    this.spreadsheetId = data.spreadsheetId;
                    localStorage.setItem('spreadsheet_id', this.spreadsheetId);
                    
                    await this.initializeSheets();
                    
                    return {
                        id: data.spreadsheetId,
                        url: data.spreadsheetUrl
                    };
                } catch (error) {
                    console.error('Error creating spreadsheet:', error);
                    return null;
                }
            }

            async initializeSheets() {
                const sheetsData = {
                    'users': [['id', 'name', 'color', 'emoji']],
                    'events': [['id', 'title', 'date', 'time', 'emoji']],
                    'todos': [['id', 'title', 'priority', 'done', 'assignedTo']],
                    'courses': [['id', 'item', 'checked']],
                    'menus': [['id', 'day', 'meal', 'emoji']],
                    'guardSchedule': [['id', 'date', 'morning', 'afternoon', 'notes']],
                    'familyInfo': [['type', 'id', 'label', 'value']]
                };

                for (const [sheetName, headers] of Object.entries(sheetsData)) {
                    await this.writeSheet(sheetName, headers);
                }
            }

            async apiCall(endpoint, method = 'GET', body = null) {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}${endpoint}`;
                const options = {
                    method,
                    headers: {
                        'Authorization': `Bearer ${this.accessToken}`,
                        'Content-Type': 'application/json',
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                return response.json();
            }

            async readSheet(sheetName) {
                try {
                    const result = await this.apiCall(`/values/${sheetName}!A:Z`);
                    return result.values || [];
                } catch (error) {
                    console.error(`Error reading ${sheetName}:`, error);
                    return [];
                }
            }

            async writeSheet(sheetName, values) {
                try {
                    await this.apiCall(`/values/${sheetName}!A:Z?valueInputOption=RAW`, 'PUT', {
                        values: values
                    });
                    return true;
                } catch (error) {
                    console.error(`Error writing ${sheetName}:`, error);
                    return false;
                }
            }

            arrayToObjects(array) {
                if (!array || array.length === 0) return [];
                const headers = array[0];
                return array.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                });
            }

            objectsToArray(objects, headers) {
                if (!objects || objects.length === 0) return [headers];
                const rows = objects.map(obj => 
                    headers.map(header => obj[header] !== undefined ? String(obj[header]) : '')
                );
                return [headers, ...rows];
            }
        }

        const gsheets = new GoogleSheetsService();

        // ==================== COMPOSANT PRINCIPAL ====================
        const App = () => {
            const [isGoogleReady, setIsGoogleReady] = useState(false);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isCreatingSheet, setIsCreatingSheet] = useState(false);
            const [spreadsheetUrl, setSpreadsheetUrl] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');

            const [users, setUsers] = useState([
                { id: 1, name: 'Maman', color: 'bg-pink-400', emoji: 'üë©' },
                { id: 2, name: 'Papa', color: 'bg-blue-400', emoji: 'üë®' },
            ]);

            const [externalPeople, setExternalPeople] = useState([
                { id: 4, name: 'Mamie', emoji: 'üëµ' },
                { id: 5, name: 'Nounou', emoji: 'üßë‚Äçüçº' },
            ]);

            const [events, setEvents] = useState([
                { id: 1, title: 'RDV p√©diatre', date: '2026-01-24', emoji: 'ü•º' },
                { id: 2, title: 'Train Paris', date: '2026-01-26', time: '14:30', emoji: 'üöÑ' },
            ]);

            const [todos, setTodos] = useState([
                { id: 1, title: 'Prendre RDV dentiste', priority: 'high', done: false, assignedTo: 1 },
                { id: 2, title: 'Acheter chaussures', priority: 'medium', done: false, assignedTo: 2 },
            ]);

            const [courses, setCourses] = useState([
                { id: 1, item: 'Lait bio', checked: false },
                { id: 2, item: 'Couches', checked: false },
            ]);

            const [menus, setMenus] = useState([
                { id: 1, day: 'Lundi', meal: 'P√¢tes bolognaise', emoji: 'üçù' },
                { id: 2, day: 'Mardi', meal: 'Poulet r√¥ti', emoji: 'üó°' },
            ]);

            const [guardSchedule, setGuardSchedule] = useState([]);
            const [familyInfo, setFamilyInfo] = useState({
                urgences: [],
                utiles: [],
                links: [],
                notes: [],
            });

            useEffect(() => {
                const initGoogle = async () => {
                    await gsheets.initialize();
                    setIsGoogleReady(true);
                    setIsAuthenticated(gsheets.isAuthenticated());
                };
                
                if (window.google) {
                    initGoogle();
                } else {
                    const checkGoogle = setInterval(() => {
                        if (window.google) {
                            clearInterval(checkGoogle);
                            initGoogle();
                        }
                    }, 100);
                }
            }, []);

            const handleGoogleLogin = async () => {
                const success = await gsheets.requestAuth();
                if (success) {
                    setIsAuthenticated(true);
                    
                    if (!gsheets.hasSpreadsheet()) {
                        setIsCreatingSheet(true);
                        const result = await gsheets.createSpreadsheet();
                        setIsCreatingSheet(false);
                        
                        if (result) {
                            setSpreadsheetUrl(result.url);
                            alert(`‚úÖ Google Sheet cr√©√© avec succ√®s !\n\nVous pouvez le consulter ici :\n${result.url}`);
                            await syncToCloud();
                        } else {
                            alert('‚ùå Erreur lors de la cr√©ation du Google Sheet');
                        }
                    } else {
                        await syncFromCloud();
                    }
                }
            };

            const handleGoogleLogout = () => {
                gsheets.logout();
                setIsAuthenticated(false);
                setSpreadsheetUrl(null);
            };

            const syncFromCloud = async () => {
                if (!isAuthenticated) return;
                
                setIsSyncing(true);
                try {
                    const todosData = await gsheets.readSheet('todos');
                    if (todosData.length > 1) {
                        const todosObjects = gsheets.arrayToObjects(todosData);
                        setTodos(todosObjects.map(t => ({
                            ...t,
                            id: parseInt(t.id),
                            assignedTo: parseInt(t.assignedTo),
                            done: t.done === 'true'
                        })));
                    }

                    const coursesData = await gsheets.readSheet('courses');
                    if (coursesData.length > 1) {
                        const coursesObjects = gsheets.arrayToObjects(coursesData);
                        setCourses(coursesObjects.map(c => ({
                            ...c,
                            id: parseInt(c.id),
                            checked: c.checked === 'true'
                        })));
                    }

                    const menusData = await gsheets.readSheet('menus');
                    if (menusData.length > 1) {
                        const menusObjects = gsheets.arrayToObjects(menusData);
                        setMenus(menusObjects.map(m => ({
                            ...m,
                            id: parseInt(m.id)
                        })));
                    }

                    setLastSync(new Date());
                } catch (error) {
                    console.error('Sync error:', error);
                }
                setIsSyncing(false);
            };

            const syncToCloud = async () => {
                if (!isAuthenticated) return;
                
                setIsSyncing(true);
                try {
                    const todosArray = gsheets.objectsToArray(
                        todos,
                        ['id', 'title', 'priority', 'done', 'assignedTo']
                    );
                    await gsheets.writeSheet('todos', todosArray);

                    const coursesArray = gsheets.objectsToArray(
                        courses,
                        ['id', 'item', 'checked']
                    );
                    await gsheets.writeSheet('courses', coursesArray);

                    const menusArray = gsheets.objectsToArray(
                        menus,
                        ['id', 'day', 'meal', 'emoji']
                    );
                    await gsheets.writeSheet('menus', menusArray);

                    setLastSync(new Date());
                } catch (error) {
                    console.error('Sync error:', error);
                }
                setIsSyncing(false);
            };

            useEffect(() => {
                if (isAuthenticated && currentUser && gsheets.hasSpreadsheet()) {
                    const timer = setTimeout(() => {
                        syncToCloud();
                    }, 2000);
                    return () => clearTimeout(timer);
                }
            }, [todos, courses, menus, isAuthenticated, currentUser]);

            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 flex items-center justify-center p-6">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">üè†</div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Plateforme Ratours</h1>
                                <p className="text-gray-600">Qui se connecte ?</p>
                            </div>

                            {isGoogleReady && !isAuthenticated && (
                                <div className="mb-6 p-4 bg-blue-50 rounded-2xl border-2 border-blue-200">
                                    <p className="text-sm text-blue-800 mb-3">‚ú® Premi√®re utilisation ? Un Google Sheet sera cr√©√© automatiquement !</p>
                                    <button
                                        onClick={handleGoogleLogin}
                                        disabled={isCreatingSheet}
                                        className="w-full bg-white border-2 border-gray-300 text-gray-700 px-4 py-3 rounded-xl hover:bg-gray-50 transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                                    >
                                        {isCreatingSheet ? (
                                            <>
                                                <Icon name="magic" size={20} className="animate-pulse" />
                                                <span className="font-medium">Cr√©ation du Google Sheet...</span>
                                            </>
                                        ) : (
                                            <>
                                                <Icon name="cloud" size={20} />
                                                <span className="font-medium">Se connecter avec Google</span>
                                            </>
                                        )}
                                    </button>
                                </div>
                            )}

                            {isAuthenticated && spreadsheetUrl && (
                                <div className="mb-6 p-4 bg-green-50 rounded-2xl border-2 border-green-200">
                                    <p className="text-sm text-green-800 mb-2">‚úÖ Connect√© √† Google Sheets</p>
                                    <a 
                                        href={spreadsheetUrl} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="text-xs text-blue-600 hover:underline"
                                    >
                                        Ouvrir le Google Sheet ‚Üí
                                    </a>
                                </div>
                            )}

                            <div className="space-y-4">
                                {users.map(user => (
                                    <button
                                        key={user.id}
                                        onClick={() => setCurrentUser(user.id)}
                                        className={`w-full ${user.color} text-white p-6 rounded-2xl hover:opacity-90 transition-all shadow-lg flex items-center justify-center gap-3`}
                                    >
                                        <span className="text-4xl">{user.emoji}</span>
                                        <span className="text-2xl font-bold">{user.name}</span>
                                    </button>
                                ))}
                            </div>

                            {isAuthenticated && (
                                <button
                                    onClick={handleGoogleLogout}
                                    className="mt-4 w-full text-sm text-gray-600 hover:text-gray-800"
                                >
                                    Se d√©connecter de Google
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            const currentUserData = users.find(u => u.id === currentUser);

            return (
                <div className="min-h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50 pb-44">
                    <div className="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-5 shadow-xl">
                        <div className="flex justify-between max-w-4xl mx-auto">
                            <div>
                                <h1 className="text-2xl font-bold">Plateforme Ratours</h1>
                                <p className="text-purple-100 text-sm">{currentUserData.emoji} {currentUserData.name}</p>
                            </div>
                            <div className="flex gap-2">
                                {isAuthenticated && gsheets.hasSpreadsheet() && (
                                    <button 
                                        onClick={syncFromCloud}
                                        disabled={isSyncing}
                                        className="bg-white bg-opacity-20 px-4 py-2 rounded-xl flex items-center gap-2"
                                    >
                                        <Icon name="sync" size={18} className={isSyncing ? 'animate-spin' : ''} />
                                        {lastSync && <span className="text-xs">{lastSync.toLocaleTimeString()}</span>}
                                    </button>
                                )}
                                <button onClick={() => setCurrentUser(null)} className="bg-white bg-opacity-20 px-4 py-2 rounded-xl">
                                    <Icon name="logout" size={18} />
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="p-4 max-w-4xl mx-auto">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-r from-purple-400 to-pink-400 rounded-3xl p-6 text-white shadow-lg">
                                    <h2 className="text-3xl font-bold mb-2">Bonjour {currentUserData.name} ! üëã</h2>
                                    <p className="text-purple-100">Lundi 26 janvier 2026</p>
                                </div>

                                {!isAuthenticated && (
                                    <div className="bg-yellow-50 border-2 border-yellow-200 rounded-2xl p-4">
                                        <p className="text-yellow-800 mb-3">‚òÅÔ∏è Connectez-vous √† Google Sheets pour sauvegarder vos donn√©es</p>
                                        <button
                                            onClick={handleGoogleLogin}
                                            className="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-xl hover:bg-yellow-500 transition-all"
                                        >
                                            Se connecter maintenant
                                        </button>
                                    </div>
                                )}

                                <div className="bg-white rounded-2xl shadow-lg p-6">
                                    <h3 className="font-bold text-gray-800 mb-4">‚úÖ Mes t√¢ches</h3>
                                    {todos.filter(t => !t.done && t.assignedTo === currentUser).map(todo => (
                                        <div key={todo.id} className="flex items-center gap-3 py-2">
                                            <input 
                                                type="checkbox" 
                                                className="h-5 w-5" 
                                                onChange={() => setTodos(todos.map(t => t.id === todo.id ? {...t, done: !t.done} : t))} 
                                            />
                                            <span>{todo.title}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'todos' && (
                            <div className="space-y-4">
                                <h2 className="text-2xl font-bold">‚úÖ T√¢ches</h2>
                                {todos.map(todo => (
                                    <div key={todo.id} className="bg-white rounded-2xl shadow-lg p-4 flex items-center gap-3">
                                        <input 
                                            type="checkbox" 
                                            checked={todo.done} 
                                            onChange={() => setTodos(todos.map(t => t.id === todo.id ? {...t, done: !t.done} : t))} 
                                            className="h-5 w-5" 
                                        />
                                        <span className={`flex-1 ${todo.done ? 'line-through text-gray-400' : ''}`}>{todo.title}</span>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'courses' && (
                            <div className="space-y-4">
                                <h2 className="text-2xl font-bold">üõí Courses</h2>
                                {courses.map(course => (
                                    <div key={course.id} className="bg-white rounded-2xl shadow-lg p-4 flex items-center gap-3">
                                        <input 
                                            type="checkbox" 
                                            checked={course.checked} 
                                            onChange={() => setCourses(courses.map(c => c.id === course.id ? {...c, checked: !c.checked} : c))} 
                                            className="h-5 w-5" 
                                        />
                                        <span className={`flex-1 ${course.checked ? 'line-through text-gray-400' : ''}`}>{course.item}</span>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'menus' && (
                            <div className="space-y-4">
                                <h2 className="text-2xl font-bold">üçΩÔ∏è Menus</h2>
                                {menus.map(m => (
                                    <div key={m.id} className="bg-white rounded-2xl shadow-lg p-5 flex gap-4">
                                        <span className="text-5xl">{m.emoji}</span>
                                        <div className="flex-1">
                                            <h3 className="font-bold text-lg">{m.day}</h3>
                                            <p className="text-gray-600">{m.meal}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t-2 shadow-2xl z-50">
                        <div className="max-w-4xl mx-auto px-1 py-2">
                            <div className="grid grid-cols-4 gap-1">
                                {[
                                    { id: 'dashboard', label: 'Accueil', emoji: 'üè†' },
                                    { id: 'todos', label: 'T√¢ches', emoji: '‚úÖ' },
                                    { id: 'courses', label: 'Courses', emoji: 'üõí' },
                                    { id: 'menus', label: 'Menus', emoji: 'üçΩÔ∏è' },
                                ].map(tab => (
                                    <button 
                                        key={tab.id} 
                                        onClick={() => setActiveTab(tab.id)} 
                                        className={`flex flex-col items-center py-2 rounded-2xl ${activeTab === tab.id ? 'bg-purple-100 text-purple-600' : 'text-gray-500'}`}
                                    >
                                        <span className="text-2xl">{tab.emoji}</span>
                                        <span className="text-xs">{tab.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
