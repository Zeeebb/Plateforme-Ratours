<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Plateforme Ratours</title>
    <meta name="theme-color" content="#E8967D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ratours">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://accounts.google.com" crossorigin>
    <link rel="preconnect" href="https://sheets.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Quicksand', 'sans-serif'],
              heading: ['Sora', 'sans-serif'],
            },
          }
        }
      }
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --bg: #FDF6EC; --card: #FFFCF5; --border: #2D2A26;
            --text: #2D2A26; --text-soft: #8C7E6A;
            --turquoise: #40B5A7; --green: #8CC63F; --yellow: #F5C542;
            --coral: #E8967D; --peach: #F4C9B3; --lavender: #B8A9D4;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Quicksand', sans-serif; background: var(--bg); color: var(--text); -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes dotPulse { 0%,80%,100% { opacity: 0.3; transform: scale(0.8); } 40% { opacity: 1; transform: scale(1.2); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .anim-in { animation: fadeIn 0.3s ease forwards; }
        .loader-dots { display: flex; gap: 8px; }
        .loader-dots span { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--border); animation: dotPulse 1.2s ease-in-out infinite; }
        .loader-dots span:nth-child(1) { background: var(--turquoise); }
        .loader-dots span:nth-child(2) { background: var(--green); animation-delay: 0.15s; }
        .loader-dots span:nth-child(3) { background: var(--yellow); animation-delay: 0.3s; }
        #splash-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; gap: 16px; animation: fadeIn 0.3s ease; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 0px); }
        input, select, textarea { font-size: 16px !important; }

        /* Neo-Brutalist Components */
        .nb-card { background: var(--card); border: 2.5px solid var(--border); border-radius: 12px; box-shadow: 4px 4px 0 var(--border); }
        .nb-flat { background: var(--card); border: 2px solid var(--border); border-radius: 10px; }
        .nb-btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; border: 2px solid var(--border); border-radius: 8px; box-shadow: 2px 2px 0 var(--border); transition: transform 0.1s, box-shadow 0.1s; cursor: pointer; font-weight: 600; font-family: 'Quicksand', sans-serif; }
        .nb-btn:hover { transform: translate(-1px, -1px); box-shadow: 3px 3px 0 var(--border); }
        .nb-btn:active { transform: translate(1px, 1px); box-shadow: 0px 0px 0 var(--border); }
        .nb-input { border: 2px solid var(--border); border-radius: 8px; background: var(--card); padding: 10px 14px; font-size: 14px; font-family: 'Quicksand', sans-serif; outline: none; transition: box-shadow 0.15s; color: var(--text); }
        .nb-input:focus { box-shadow: 3px 3px 0 var(--turquoise); }
        .nb-select { border: 2px solid var(--border); border-radius: 8px; background: var(--card); padding: 10px 14px; font-size: 14px; font-family: 'Quicksand', sans-serif; outline: none; appearance: none; color: var(--text); background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='%232D2A26' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%232D2A26' stroke-width='2' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
        .nb-select:focus { box-shadow: 3px 3px 0 var(--turquoise); }
        .nb-tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 10px; border: 1.5px solid var(--border); border-radius: 6px; font-size: 11px; font-weight: 600; }
        .nb-overlay { position: fixed; inset: 0; background: rgba(45,42,38,0.5); display: flex; align-items: center; justify-content: center; z-index: 60; padding: 16px; backdrop-filter: blur(2px); }
        .nb-modal { background: var(--card); border: 3px solid var(--border); border-radius: 16px; box-shadow: 6px 6px 0 var(--border); max-width: 420px; width: 100%; padding: 20px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.2s ease; }
        .nb-check { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 4px; appearance: none; cursor: pointer; position: relative; background: var(--card); flex-shrink: 0; }
        .nb-check:checked { background: var(--turquoise); }
        .nb-check:checked::after { content: '\2713'; position: absolute; top: -2px; left: 3px; color: white; font-weight: 700; font-size: 14px; }
        .cdot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--border); display: inline-block; flex-shrink: 0; }
        .nav-tab { transition: all 0.15s; border: 2px solid transparent; border-radius: 8px; }
        .nav-tab.active { background: var(--yellow); border: 2px solid var(--border); box-shadow: 2px 2px 0 var(--border); transform: translateY(-2px); }
        .card-themed { background: var(--card); border: 2.5px solid var(--border); border-radius: 12px; box-shadow: 4px 4px 0 var(--border); }
    </style>
</head>
<body>
    <div id="root">
        <div id="splash-screen">
            <svg width="56" height="56" viewBox="0 0 40 40"><rect x="6" y="6" width="27" height="27" rx="3" fill="var(--turquoise)" stroke="var(--border)" stroke-width="1.5" transform="rotate(45 20 20)"/></svg>
            <div style="font-family:Sora,sans-serif;font-size:22px;font-weight:800;color:var(--text)">Plateforme Ratours</div>
            <div class="loader-dots"><span></span><span></span><span></span></div>
            <div style="font-size:12px;color:var(--text-soft)">Chargement...</div>
        </div>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js').then(function(reg) {
                    console.log('SW registered:', reg.scope);
                }).catch(function(err) { console.log('SW failed:', err); });
            });
        }
    </script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const GOOGLE_CLIENT_ID = '988519105715-eqfihmrhgotpkund2ub9nvb3ov7nfde4.apps.googleusercontent.com';
        const SPREADSHEET_ID = '186a_JILQOYaF52HWNWunctYmriWTYaRIo4rlDscixcw';

        const EVENT_COLORS = [
            { id: 'turquoise', name: 'Turquoise', hex: '#40B5A7' },
            { id: 'green', name: 'Vert', hex: '#8CC63F' },
            { id: 'yellow', name: 'Jaune', hex: '#F5C542' },
            { id: 'coral', name: 'Corail', hex: '#E8967D' },
            { id: 'peach', name: 'PÃªche', hex: '#F4C9B3' },
            { id: 'lavender', name: 'Lavande', hex: '#B8A9D4' },
            { id: 'blue', name: 'Bleu', hex: '#6CB4D9' },
            { id: 'rose', name: 'Rose', hex: '#E899AC' },
        ];
        
        const Icon = ({ name, size = 24, color }) => {
            const s = size;
            const paths = {
                home: `<path d="M219.31,108.68l-80-80a16,16,0,0,0-22.62,0l-80,80A15.87,15.87,0,0,0,32,120v96a8,8,0,0,0,8,8H96a8,8,0,0,0,8-8V160h48v56a8,8,0,0,0,8,8h56a8,8,0,0,0,8-8V120A15.87,15.87,0,0,0,219.31,108.68Z"/>`,
                calendar: `<path d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32ZM48,80H208v128H48Z"/>`,
                check: `<path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm45.66,85.66-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"/>`,
                cart: `<path d="M230.14,58.87A8,8,0,0,0,224,56H62.68L56.6,22.57A8,8,0,0,0,48.73,16H24a8,8,0,0,0,0,16H41.72L70.46,176.65a24,24,0,1,0,30.05,5.35H170.1a24,24,0,1,0,25.81-7.47L210.42,72H224A8,8,0,0,0,230.14,58.87Z"/>`,
                chef: `<path d="M240,104a64,64,0,0,0-128-2.11A64,64,0,0,0,48,104c0,9.83,2.41,19.21,6.93,28.88L40.68,215.72A8,8,0,0,0,48,224h160a8,8,0,0,0,7.32-8.28L201.07,132.88A63.42,63.42,0,0,0,240,104Z"/>`,
                users: `<path d="M164.47,195.63a8,8,0,0,1-6.7,12.37H16.23a8,8,0,0,1-6.7-12.37,80.15,80.15,0,0,1,44.52-34.92,48,48,0,1,1,65.95,0A80.15,80.15,0,0,1,164.47,195.63Z"/>`,
                settings: `<path d="M216,130.16q.06-2.16,0-4.32l14.92-18.64a8,8,0,0,0,1.48-7.06,107.6,107.6,0,0,0-10.88-26.16,8,8,0,0,0-6-3.93l-23.72-2.64q-1.48-1.56-3-3L186,40.54a8,8,0,0,0-3.94-6,107.29,107.29,0,0,0-26.15-10.87,8,8,0,0,0-7.06,1.48L130.16,40Q128,40,125.84,40L107.2,25.11a8,8,0,0,0-7.06-1.48A107.6,107.6,0,0,0,74,34.51a8,8,0,0,0-3.93,6L67.43,64.27q-1.56,1.49-3,3L40.54,70a8,8,0,0,0-6,3.94,107.71,107.71,0,0,0-10.87,26.15,8,8,0,0,0,1.48,7.06L40,125.84q-.06,2.16,0,4.32L25.11,148.8a8,8,0,0,0-1.48,7.06,107.6,107.6,0,0,0,10.88,26.16,8,8,0,0,0,6,3.93l23.72,2.64q1.49,1.56,3,3L70,215.46a8,8,0,0,0,3.94,6,107.71,107.71,0,0,0,26.15,10.87,8,8,0,0,0,7.06-1.48L125.84,216q2.16.06,4.32,0l18.64,14.92a8,8,0,0,0,7.06,1.48,107.21,107.21,0,0,0,26.16-10.88,8,8,0,0,0,3.93-6l2.64-23.72q1.56-1.48,3-3L215.46,186a8,8,0,0,0,6-3.94,107.71,107.71,0,0,0,10.87-26.15,8,8,0,0,0-1.48-7.06ZM128,168a40,40,0,1,1,40-40A40,40,0,0,1,128,168Z"/>`,
                chart: `<path d="M224,200h-8V40a8,8,0,0,0-8-8H152a8,8,0,0,0-8,8V80H96a8,8,0,0,0-8,8v40H48a8,8,0,0,0-8,8v64H32a8,8,0,0,0,0,16H224a8,8,0,0,0,0-16Z"/>`,
                baby: `<path d="M92,140a12,12,0,1,1,12-12A12,12,0,0,1,92,140Zm72-24a12,12,0,1,0,12,12A12,12,0,0,0,164,116ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Z"/>`,
                notes: `<path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,176H96a8,8,0,0,1,0-16h64a8,8,0,0,1,0,16Zm0-32H96a8,8,0,0,1,0-16h64a8,8,0,0,1,0,16Zm-8-56V51.31L188.69,88Z"/>`,
                plus: `<path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"/>`,
                x: `<path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"/>`,
                trash: `<path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM112,168a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"/>`,
                edit: `<path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63Z"/>`,
                cloud: `<path d="M160,40A88.09,88.09,0,0,0,81.29,88.68,64,64,0,1,0,72,216h88a88,88,0,0,0,0-176Z"/>`,
                sync: `<path d="M197.67,186.37a8,8,0,0,1,0,11.29C196.58,198.73,170.82,224,128,224c-37.08,0-64.1-22.08-80-39.68V208a8,8,0,0,1-16,0V160a8,8,0,0,1,8-8H88a8,8,0,0,1,0,16H55.44C67.76,183.86,93,208,128,208c36,0,57.62-21.41,58.67-22.37A8,8,0,0,1,197.67,186.37ZM216,40a8,8,0,0,0-8,8V71.68C192.1,54.08,165.08,32,128,32,85.18,32,59.42,57.27,58.34,58.34a8,8,0,0,0,11.3,11.34C70.38,69,92,48,128,48c35,0,60.24,24.14,72.56,40H168a8,8,0,0,0,0,16h48a8,8,0,0,0,8-8V48A8,8,0,0,0,216,40Z"/>`,
                save: `<path d="M219.31,72,184,36.69A15.86,15.86,0,0,0,172.69,32H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V83.31A15.86,15.86,0,0,0,219.31,72ZM160,80v48H96V80Zm48,128H48V48H80v80a8,8,0,0,0,8,8h80a8,8,0,0,0,8-8V48h4.69L208,75.31Z"/>`,
                logout: `<path d="M112,216a8,8,0,0,1-8,8H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h56a8,8,0,0,1,0,16H48V208h56A8,8,0,0,1,112,216Zm117.66-93.66-40-40a8,8,0,0,0-11.32,11.32L204.69,120H112a8,8,0,0,0,0,16h92.69l-26.35,26.34a8,8,0,0,0,11.32,11.32l40-40A8,8,0,0,0,229.66,122.34Z"/>`,
                star: `<path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,92l59.46-5.15,23.21-55.36a16.4,16.4,0,0,1,30.5,0l23.21,55.36L226.92,92a16.46,16.46,0,0,1,7.37,22.85Z"/>`,
                search: `<path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"/>`,
                heart: `<path d="M240,98a57.63,57.63,0,0,1-17,41L128,234,33,139A58,58,0,0,1,74,40a57.85,57.85,0,0,1,54,36.06A57.85,57.85,0,0,1,182,40,58,58,0,0,1,240,98Z"/>`,
                palette: `<path d="M200.77,53.89A103.27,103.27,0,0,0,128,24h-1.07A104,104,0,0,0,24,128c0,43,26.58,79.06,69.36,94.17A32,32,0,0,0,136,192a16,16,0,0,1,16-16h46.21a31.81,31.81,0,0,0,31.2-24.88,104.43,104.43,0,0,0,2.59-24A103.28,103.28,0,0,0,200.77,53.89ZM84,168a12,12,0,1,1,12-12A12,12,0,0,1,84,168Zm0-56a12,12,0,1,1,12-12A12,12,0,0,1,84,112Zm44-24a12,12,0,1,1,12-12A12,12,0,0,1,128,88Zm44,24a12,12,0,1,1,12-12A12,12,0,0,1,172,112Z"/>`,
            };
            const p = paths[name];
            if (!p) return React.createElement('span', {style: {fontSize: size}}, 'â€¢');
            return React.createElement('span', {
                style: { display: 'inline-flex', width: s, height: s },
                dangerouslySetInnerHTML: { __html: `<svg width="${s}" height="${s}" viewBox="0 0 256 256" fill="${color || 'currentColor'}">${p}</svg>` }
            });
        };

        // ===== HEADERS CONSTANTS =====
        const EVENTS_HEADERS = ['id', 'title', 'date', 'endDate', 'time', 'category', 'assignedTo', 'emoji', 'calendarEventId', 'color'];
        const TODOS_HEADERS = ['id', 'title', 'category', 'priority', 'done', 'assignedTo'];
        const COURSES_HEADERS = ['id', 'item', 'category', 'checked'];
        const MENUS_HEADERS = ['id', 'day', 'meal', 'emoji'];
        const NOTES_HEADERS = ['id', 'text', 'author', 'date'];
        const GUARD_HEADERS = ['id', 'date', 'morning', 'afternoon', 'notes'];
        const FAMILY_HEADERS = ['section', 'id', 'label', 'value', 'type'];
        const CATEGORIES_HEADERS = ['section', 'id', 'name', 'emoji'];
        const EXTERNAL_PEOPLE_HEADERS = ['id', 'name', 'emoji'];

        const EMOJI_PICKER = ['ðŸ ','ðŸ¥','ðŸ«','ðŸŽ‰','ðŸŽ­','ðŸŽµ','ðŸŽ¨','ðŸ‹ï¸','ðŸš—','âœˆï¸','ðŸ–ï¸','â›ª','ðŸ’¼','ðŸ’°','ðŸ“¦','ðŸ“±','ðŸ”§','ðŸ§¹','ðŸ¼','ðŸ‘¶','ðŸ‘¨â€ðŸ‘©â€ðŸ‘§','ðŸ‘µ','ðŸ¶','ðŸ±','ðŸ¥–','ðŸ¥—','ðŸ¥©','ðŸ•','ðŸ°','ðŸ§','â˜•','ðŸ·','ðŸ’Š','ðŸ©º','ðŸ“ž','ðŸ“','ðŸŽ','ðŸ›ï¸','ðŸ‘—','ðŸ‘Ÿ','ðŸ§¸','ðŸ“š','ðŸŽ“','âš½','ðŸŽ®','ðŸŒ¸','ðŸŒ','â¤ï¸'];
        const DAY_ORDER = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];

        class GoogleServicesManager {
            constructor() {
                this.accessToken = null;
                this.tokenClient = null;
                this.spreadsheetId = SPREADSHEET_ID;
                this.calendarId = null; // loaded from Sheet settings (shared)
            }

            initialize() {
                return new Promise((resolve) => {
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/calendar',
                        callback: (response) => {
                            if (response.access_token) {
                                this.accessToken = response.access_token;
                                localStorage.setItem('gsheets_token', response.access_token);
                            }
                        },
                    });
                    const savedToken = localStorage.getItem('gsheets_token');
                    if (savedToken) this.accessToken = savedToken;
                    resolve(true);
                });
            }

            async requestAuth() {
                return new Promise((resolve) => {
                    this.tokenClient.callback = (response) => {
                        if (response.access_token) {
                            this.accessToken = response.access_token;
                            localStorage.setItem('gsheets_token', response.access_token);
                            resolve(true);
                        } else resolve(false);
                    };
                    this.tokenClient.requestAccessToken();
                });
            }

            isAuthenticated() { return !!this.accessToken; }
            hasSpreadsheet() { return !!this.spreadsheetId; }

            // Validate saved token with a lightweight API call
            async validateToken() {
                if (!this.accessToken) return false;
                try {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}?fields=spreadsheetId`;
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    if (response.ok) return true;
                    console.log('âš ï¸ Token expirÃ©, tentative de refresh silencieux...');
                    this.accessToken = null;
                    localStorage.removeItem('gsheets_token');
                    return false;
                } catch (error) {
                    console.error('Erreur validation token:', error);
                    this.accessToken = null;
                    localStorage.removeItem('gsheets_token');
                    return false;
                }
            }

            // Try to get a new token silently (no popup if consent already granted)
            silentRefresh() {
                return new Promise((resolve) => {
                    if (!this.tokenClient) { resolve(false); return; }
                    // Timeout: if no response in 5s, silent refresh failed
                    const timeout = setTimeout(() => { resolve(false); }, 5000);
                    this.tokenClient.callback = (response) => {
                        clearTimeout(timeout);
                        if (response.access_token) {
                            this.accessToken = response.access_token;
                            localStorage.setItem('gsheets_token', response.access_token);
                            resolve(true);
                        } else {
                            resolve(false);
                        }
                    };
                    this.tokenClient.error_callback = () => {
                        clearTimeout(timeout);
                        resolve(false);
                    };
                    // prompt: '' = no popup, silent only
                    this.tokenClient.requestAccessToken({ prompt: '' });
                });
            }

            logout() {
                this.accessToken = null;
                localStorage.removeItem('gsheets_token');
            }

            async readSheet(sheetName) {
                try {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}/values/${sheetName}!A:Z`;
                    let response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    if (response.status === 401 || response.status === 403) {
                        // Try silent refresh before giving up
                        console.log(`âš ï¸ Token expirÃ© lors de la lecture de ${sheetName}, refresh...`);
                        const refreshed = await this.silentRefresh();
                        if (refreshed) {
                            response = await fetch(url, {
                                headers: { 'Authorization': `Bearer ${this.accessToken}` }
                            });
                        }
                        if (!refreshed || response.status === 401 || response.status === 403) {
                            this.accessToken = null;
                            localStorage.removeItem('gsheets_token');
                            throw new Error('TOKEN_EXPIRED');
                        }
                    }
                    const result = await response.json();
                    return result.values || [];
                } catch (error) {
                    console.error(`Erreur lecture ${sheetName}:`, error);
                    if (error.message === 'TOKEN_EXPIRED') throw error;
                    return [];
                }
            }

            // Create a sheet tab if it doesn't exist
            async ensureSheet(sheetName) {
                try {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}:batchUpdate`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            requests: [{ addSheet: { properties: { title: sheetName } } }]
                        })
                    });
                    if (response.ok) {
                        console.log(`âœ… Onglet "${sheetName}" crÃ©Ã©`);
                        return true;
                    }
                    // 400 = sheet already exists (that's fine)
                    return response.status === 400;
                } catch (error) {
                    console.error(`Erreur crÃ©ation onglet ${sheetName}:`, error);
                    return false;
                }
            }

            async writeSheet(sheetName, values) {
                try {
                    // Helper: make an authenticated fetch, retry once with silent refresh on 401
                    const authFetch = async (url, options) => {
                        let response = await fetch(url, { ...options, headers: { ...options.headers, 'Authorization': `Bearer ${this.accessToken}` } });
                        if (response.status === 401 || response.status === 403) {
                            console.log(`âš ï¸ Token expirÃ© lors de l'Ã©criture de ${sheetName}, refresh...`);
                            const refreshed = await this.silentRefresh();
                            if (refreshed) {
                                response = await fetch(url, { ...options, headers: { ...options.headers, 'Authorization': `Bearer ${this.accessToken}` } });
                            }
                            if (!refreshed || response.status === 401 || response.status === 403) {
                                this.accessToken = null;
                                localStorage.removeItem('gsheets_token');
                                throw new Error('TOKEN_EXPIRED');
                            }
                        }
                        return response;
                    };

                    // Ã‰TAPE 1 : CLEAR le sheet
                    const clearUrl = `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}/values/${sheetName}!A:Z:clear`;
                    const clearResponse = await authFetch(clearUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    // Sheet tab doesn't exist â†’ create it and skip CLEAR
                    if (!clearResponse.ok) {
                        console.log(`Onglet "${sheetName}" introuvable (${clearResponse.status}), crÃ©ation...`);
                        await this.ensureSheet(sheetName);
                    }
                    
                    // Ã‰TAPE 2 : Ã‰crire les nouvelles donnÃ©es
                    const updateUrl = `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}/values/${sheetName}!A1?valueInputOption=RAW`;
                    const updateResponse = await authFetch(updateUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values })
                    });
                    if (!updateResponse.ok) {
                        console.error(`Erreur UPDATE ${updateResponse.status}`);
                        return false;
                    }
                    
                    return true;
                } catch (error) {
                    console.error(`Erreur Ã©criture ${sheetName}:`, error);
                    if (error.message === 'TOKEN_EXPIRED') throw error;
                    return false;
                }
            }

            // === GOOGLE CALENDAR ===
            // List user's Google Calendars
            async listCalendars() {
                try {
                    const url = 'https://www.googleapis.com/calendar/v3/users/me/calendarList';
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    if (!response.ok) return [];
                    const data = await response.json();
                    return (data.items || []).map(c => ({ id: c.id, name: c.summary }));
                } catch (e) { console.error('Erreur listCalendars:', e); return []; }
            }

            // Save calendar ID to Sheet settings (shared across all users)
            async saveCalendarIdToSheet(calId) {
                try {
                    await this.ensureSheet('settings');
                    await this.writeSheet('settings', [['key', 'value'], ['calendarId', calId]]);
                } catch(e) { console.error('Erreur save calendarId:', e); }
            }

            // Read calendar ID from Sheet settings
            async loadCalendarIdFromSheet() {
                try {
                    const data = await this.readSheet('settings');
                    if (data.length > 1) {
                        const rows = this.arrayToObjects(data);
                        const row = rows.find(r => r.key === 'calendarId');
                        if (row && row.value) return row.value;
                    }
                    return null;
                } catch(e) { return null; }
            }

            async createCalendarEvent(event) {
                if (!this.calendarId) return null;
                try {
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${this.calendarId}/events`;
                    let eventBody;
                    if (event.endDate) {
                        // PÃ©riode : all-day event
                        const endDateObj = new Date(event.endDate + 'T12:00:00');
                        endDateObj.setDate(endDateObj.getDate() + 1);
                        const exclusiveEnd = endDateObj.toISOString().split('T')[0];
                        eventBody = {
                            summary: event.title,
                            description: `[Ratours] ${event.category}`,
                            start: { date: event.date },
                            end: { date: exclusiveEnd }
                        };
                    } else {
                        eventBody = {
                            summary: event.title,
                            description: `[Ratours] ${event.category}`,
                            start: { dateTime: `${event.date}T${event.time || '09:00'}:00`, timeZone: 'Europe/Paris' },
                            end: { dateTime: `${event.date}T${event.time ? this.addHour(event.time) : '10:00'}:00`, timeZone: 'Europe/Paris' }
                        };
                    }
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(eventBody)
                    });
                    if (!response.ok) return null;
                    const created = await response.json();
                    return created.id;
                } catch (error) {
                    console.error('Erreur crÃ©ation event:', error);
                    return null;
                }
            }

            async deleteCalendarEvent(calendarEventId) {
                if (!this.calendarId) return false;
                try {
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${this.calendarId}/events/${calendarEventId}`;
                    const response = await fetch(url, { method: 'DELETE', headers: { 'Authorization': `Bearer ${this.accessToken}` } });
                    return response.ok;
                } catch (error) {
                    console.error('Erreur suppression event:', error);
                    return false;
                }
            }

            async updateCalendarEvent(calendarEventId, event) {
                if (!this.calendarId || !calendarEventId) return false;
                try {
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${this.calendarId}/events/${calendarEventId}`;
                    let eventBody;
                    if (event.endDate) {
                        const endDateObj = new Date(event.endDate + 'T12:00:00');
                        endDateObj.setDate(endDateObj.getDate() + 1);
                        const exclusiveEnd = endDateObj.toISOString().split('T')[0];
                        eventBody = { summary: event.title, description: `[Ratours] ${event.category}`, start: { date: event.date }, end: { date: exclusiveEnd } };
                    } else {
                        eventBody = { summary: event.title, description: `[Ratours] ${event.category}`, start: { dateTime: `${event.date}T${event.time || '09:00'}:00`, timeZone: 'Europe/Paris' }, end: { dateTime: `${event.date}T${event.time ? this.addHour(event.time) : '10:00'}:00`, timeZone: 'Europe/Paris' } };
                    }
                    const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${this.accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(eventBody) });
                    return response.ok;
                } catch (error) { console.error('Erreur update event:', error); return false; }
            }

            // IMPORT events FROM Google Calendar
            async fetchCalendarEvents(timeMinISO, timeMaxISO) {
                if (!this.calendarId) { console.log('âŒ No calendarId'); return []; }
                try {
                    console.log('ðŸ“… Fetching events from calendar:', this.calendarId);
                    console.log('ðŸ“… Range:', timeMinISO, 'â†’', timeMaxISO);
                    const params = new URLSearchParams({
                        timeMin: timeMinISO,
                        timeMax: timeMaxISO,
                        singleEvents: 'true',
                        orderBy: 'startTime',
                        maxResults: '250'
                    });
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(this.calendarId)}/events?${params}`;
                    console.log('ðŸ“… URL:', url);
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    console.log('ðŸ“… Response status:', response.status);
                    if (!response.ok) {
                        const err = await response.text();
                        console.error('âŒ Fetch calendar events failed:', response.status, err);
                        return [];
                    }
                    const data = await response.json();
                    console.log('ðŸ“… Raw items count:', (data.items || []).length);
                    if (data.items && data.items.length > 0) {
                        console.log('ðŸ“… First event:', data.items[0].summary, data.items[0].start);
                    }
                    return (data.items || []).map(item => {
                        const isAllDay = !!item.start?.date;
                        const startDate = isAllDay ? item.start.date : (item.start?.dateTime || '').split('T')[0];
                        let endDate = '';
                        if (isAllDay && item.end?.date) {
                            // Google uses exclusive end date for all-day events, subtract 1 day
                            const d = new Date(item.end.date + 'T12:00:00');
                            d.setDate(d.getDate() - 1);
                            const endStr = d.toISOString().split('T')[0];
                            // Only set endDate if it's a multi-day event
                            if (endStr !== startDate) endDate = endStr;
                        }
                        const time = isAllDay ? '' : ((item.start?.dateTime || '').split('T')[1] || '').substring(0, 5);
                        return {
                            id: Date.now() + Math.random(),
                            title: item.summary || '(sans titre)',
                            date: startDate,
                            endDate,
                            time,
                            category: '',
                            assignedTo: '[]',
                            emoji: 'ðŸ“…',
                            calendarEventId: item.id,
                            color: ''
                        };
                    });
                } catch (error) {
                    console.error('Erreur import events:', error);
                    return [];
                }
            }

            addHour(time) {
                const [h, m] = time.split(':');
                const hour = parseInt(h);
                // FIX: handle 23h â†’ clamp to 23:59
                if (hour >= 23) return '23:59';
                return `${(hour + 1).toString().padStart(2, '0')}:${m}`;
            }

            arrayToObjects(array) {
                if (!array || array.length === 0) return [];
                const headers = array[0];
                return array.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => { obj[header] = row[index] || ''; });
                    return obj;
                });
            }

            objectsToArray(objects, headers) {
                if (!objects || objects.length === 0) return [headers];
                const rows = objects.map(obj => headers.map(header => {
                    const val = obj[header];
                    if (val === null || val === undefined || val === '') return '';
                    return String(val);
                }));
                return [headers, ...rows];
            }
        }

        const gsheets = new GoogleServicesManager();

        // ===== HELPER =====
        const formatDateFr = (dateStr) => {
            if (!dateStr) return '';
            const d = new Date(dateStr + 'T12:00:00');
            return d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
        };

        // ===== APP =====
        const APP_VERSION = 'v3.0';
        const App = () => {
            const [isGoogleReady, setIsGoogleReady] = useState(false);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [hasLoadedFromCloud, setHasLoadedFromCloud] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            const [currentUser, setCurrentUser] = useState(() => {
                const saved = localStorage.getItem('ratours_current_user');
                return saved ? parseInt(saved) : null;
            });
            const [activeTab, setActiveTab] = useState('dashboard');
            const [showAddModal, setShowAddModal] = useState(false);
            const [addType, setAddType] = useState('');
            const [currentWeekOffset, setCurrentWeekOffset] = useState(0);
            const [calendarMonthOffset, setCalendarMonthOffset] = useState(0);
            const [editingInfo, setEditingInfo] = useState(null);
            const [infoLabel, setInfoLabel] = useState('');
            const [infoValue, setInfoValue] = useState('');
            const [calendarEnabled, setCalendarEnabled] = useState(false);
            const [calendarStatus, setCalendarStatus] = useState('');
            const [availableCalendars, setAvailableCalendars] = useState([]);
            const [showCalendarPicker, setShowCalendarPicker] = useState(false);
            const [addCategoryModal, setAddCategoryModal] = useState(null);
            const [newCatName, setNewCatName] = useState('');
            const [newCatEmoji, setNewCatEmoji] = useState('');
            const [hideDoneTodos, setHideDoneTodos] = useState(false);
            const [editingTodo, setEditingTodo] = useState(null); // {id, title, priority, assignedTo}
            const [editingEvent, setEditingEvent] = useState(null); // {id, title, date, endDate, time, category, color}
            const [reconnectFailed, setReconnectFailed] = useState(false);
            const [assignPickerTodo, setAssignPickerTodo] = useState(null);
            const [noteText, setNoteText] = useState('');
            const [addPersonModal, setAddPersonModal] = useState(false);
            const [newPersonName, setNewPersonName] = useState('');
            const [newPersonEmoji, setNewPersonEmoji] = useState('');

            const [users] = useState([
                { id: 1, name: 'Emilie', color: '#40B5A7', emoji: 'ðŸ‘©', shape: 'diamond' },
                { id: 2, name: 'SÃ©bastien', color: '#B8A9D4', emoji: 'ðŸ‘¨', shape: 'pentagon' },
            ]);
            
            // SVG Avatar helper
            const AvatarSVG = ({shape, color, size}) => {
                const shapes = {
                    diamond: `<rect x="6" y="6" width="27" height="27" rx="3" fill="${color}" transform="rotate(45 20 20)"/>`,
                    pentagon: `<polygon points="20,2 38,15 31,36 9,36 2,15" fill="${color}"/>`,
                    circle: `<circle cx="20" cy="20" r="17" fill="${color}"/>`,
                    hexagon: `<polygon points="20,2 36,11 36,29 20,38 4,29 4,11" fill="${color}"/>`,
                };
                return React.createElement('span', {
                    style: { display: 'inline-flex', width: size + 'px', height: size + 'px', lineHeight: 0 },
                    dangerouslySetInnerHTML: { __html: `<svg width="${size}" height="${size}" viewBox="0 0 40 40">${shapes[shape] || shapes.circle}</svg>` }
                });
            };
            const [externalPeople, setExternalPeople] = useState([
                { id: 4, name: 'Mamie', emoji: 'ðŸ‘µ' },
                { id: 5, name: 'Nounou', emoji: 'ðŸ§‘â€ðŸ¼' },
            ]);
            const [categories, setCategories] = useState({
                courses: [
                    { id: 'alimentaire', name: 'Alimentaire', emoji: 'ðŸ¥–' },
                    { id: 'enfant', name: 'Enfant', emoji: 'ðŸ¼' },
                    { id: 'maison', name: 'Maison', emoji: 'ðŸ§¹' },
                ],
                todos: [
                    { id: 'rdv', name: 'RDV', emoji: 'ðŸ“ž' },
                    { id: 'enfant', name: 'Enfant', emoji: 'ðŸ‘¶' },
                    { id: 'maison', name: 'Maison', emoji: 'ðŸ ' },
                ],
                events: [
                    { id: 'medical', name: 'MÃ©dical', emoji: 'ðŸ¥' },
                    { id: 'voyage', name: 'Voyage', emoji: 'âœˆï¸' },
                    { id: 'ecole', name: 'Ã‰cole', emoji: 'ðŸ«' },
                    { id: 'famille', name: 'Famille', emoji: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§' },
                ]
            });

            const [events, setEvents] = useState([]);
            const [todos, setTodos] = useState([]);
            const [courses, setCourses] = useState([]);
            const [menus, setMenus] = useState([]);
            const [notes, setNotes] = useState([]);
            const [guardSchedule, setGuardSchedule] = useState([]);
            const [familyInfo, setFamilyInfo] = useState({
                urgences: [], utiles: [], links: [], notes: []
            });

            const [newItem, setNewItem] = useState({
                title: '', date: '', endDate: '', time: '', category: '', priority: 'medium', assignedTo: null, day: '', isPeriod: false, color: ''
            });
            const resetNewItem = () => setNewItem({ title: '', date: '', endDate: '', time: '', category: '', priority: 'medium', assignedTo: null, day: '', isPeriod: false, color: '' });

            const allPeople = [...users, ...externalPeople];

            // ===== PERSIST USER CHOICE =====
            useEffect(() => {
                if (currentUser) localStorage.setItem('ratours_current_user', String(currentUser));
                else localStorage.removeItem('ratours_current_user');
            }, [currentUser]);

            // ===== GOOGLE INIT (validate token, try silent refresh) =====
            useEffect(() => {
                const initGoogle = async () => {
                    await gsheets.initialize();
                    setIsGoogleReady(true);
                    if (gsheets.accessToken) {
                        console.log('ðŸ”‘ Token trouvÃ© en localStorage, validation...');
                        const valid = await gsheets.validateToken();
                        if (valid) {
                            console.log('âœ… Token valide, connectÃ© !');
                            setIsAuthenticated(true);
                        } else {
                            console.log('ðŸ”„ Token expirÃ©, refresh silencieux...');
                            const refreshed = await gsheets.silentRefresh();
                            setIsAuthenticated(refreshed);
                            console.log(refreshed ? 'âœ… Refresh rÃ©ussi' : 'âŒ Refresh Ã©chouÃ©, connexion manuelle requise');
                        }
                    } else {
                        const hadUser = localStorage.getItem('ratours_current_user');
                        if (hadUser) {
                            console.log('ðŸ”„ Pas de token mais user connu, refresh silencieux...');
                            const refreshed = await gsheets.silentRefresh();
                            setIsAuthenticated(refreshed);
                            console.log(refreshed ? 'âœ… Refresh rÃ©ussi' : 'âŒ Refresh Ã©chouÃ©');
                        }
                    }
                    setIsLoading(false);
                };
                if (window.google) { initGoogle(); }
                else {
                    const checkGoogle = setInterval(() => {
                        if (window.google) { clearInterval(checkGoogle); initGoogle(); }
                    }, 100);
                    setTimeout(() => { clearInterval(checkGoogle); setIsLoading(false); setIsGoogleReady(true); }, 5000);
                }
            }, []);

            useEffect(() => {
                if (isAuthenticated && currentUser && gsheets.hasSpreadsheet() && !hasLoadedFromCloud) syncFromCloud();
            }, [currentUser, isAuthenticated]);

            // Auto-reconnect when user is known but session expired
            useEffect(() => {
                if (currentUser && !isAuthenticated && !isLoading && isGoogleReady) {
                    console.log('ðŸ”„ Auto-reconnect: user connu mais pas auth...');
                    const tryReconnect = async () => {
                        // 1st: try silent refresh (no popup)
                        console.log('ðŸ”„ Tentative silencieuse...');
                        const refreshed = await gsheets.silentRefresh();
                        if (refreshed) {
                            console.log('âœ… Reconnexion silencieuse rÃ©ussie !');
                            setIsAuthenticated(true);
                            return;
                        }
                        // 2nd: silent failed â†’ show manual button
                        console.log('âš ï¸ Refresh silencieux Ã©chouÃ© â†’ bouton manuel');
                        setReconnectFailed(true);
                    };
                    const timer = setTimeout(tryReconnect, 300);
                    return () => clearTimeout(timer);
                }
            }, [currentUser, isAuthenticated, isLoading, isGoogleReady]);

            // ===== SYNC FROM CLOUD =====
            const syncFromCloud = async () => {
                if (!isAuthenticated) return;
                setIsSyncing(true);
                try {
                    const todosData = await gsheets.readSheet('todos');
                    if (todosData.length > 1) {
                        setTodos(gsheets.arrayToObjects(todosData).map(t => ({
                            ...t, id: parseInt(t.id), assignedTo: t.assignedTo ? parseInt(t.assignedTo) : null, done: t.done === 'true'
                        })));
                    }
                    const coursesData = await gsheets.readSheet('courses');
                    if (coursesData.length > 1) {
                        setCourses(gsheets.arrayToObjects(coursesData).map(c => ({
                            ...c, id: parseInt(c.id), checked: c.checked === 'true'
                        })));
                    }
                    const menusData = await gsheets.readSheet('menus');
                    if (menusData.length > 1) {
                        setMenus(gsheets.arrayToObjects(menusData).map(m => ({ ...m, id: parseInt(m.id) })));
                    }
                    const eventsData = await gsheets.readSheet('events');
                    if (eventsData.length > 1) {
                        setEvents(gsheets.arrayToObjects(eventsData).map(e => {
                            let parsedAssignedTo = [];
                            try { parsedAssignedTo = e.assignedTo ? JSON.parse(e.assignedTo) : []; } catch (err) { parsedAssignedTo = []; }
                            return {
                                ...e,
                                id: parseInt(e.id) || Date.now(),
                                assignedTo: Array.isArray(parsedAssignedTo) ? parsedAssignedTo : [],
                                calendarEventId: e.calendarEventId || null,
                                endDate: e.endDate || '',
                                emoji: e.emoji || 'ðŸ“…'
                            };
                        }));
                    }
                    const guardData = await gsheets.readSheet('guardSchedule');
                    if (guardData.length > 1) {
                        setGuardSchedule(gsheets.arrayToObjects(guardData).map(g => ({
                            ...g, id: parseInt(g.id),
                            morning: g.morning ? parseInt(g.morning) : null,
                            afternoon: g.afternoon ? parseInt(g.afternoon) : null
                        })));
                    }
                    const familyData = await gsheets.readSheet('familyInfo');
                    if (familyData.length > 1) {
                        const familyObjects = gsheets.arrayToObjects(familyData);
                        const reconstructed = { urgences: [], utiles: [], links: [], notes: [] };
                        familyObjects.forEach(item => {
                            if (reconstructed[item.section]) {
                                reconstructed[item.section].push({ id: parseInt(item.id), label: item.label, value: item.value, type: item.type });
                            }
                        });
                        setFamilyInfo(reconstructed);
                    }
                    // FIX: try both "notes" and "Notes" tab names (Google Sheets is case-sensitive)
                    let notesData = await gsheets.readSheet('notes');
                    if (notesData.length <= 1) {
                        console.log('âš ï¸ Tab "notes" vide ou inexistant, essai "Notes"...');
                        notesData = await gsheets.readSheet('Notes');
                    }
                    console.log('{React.createElement(Icon, {name:"notes", size:22})} Notes data:', notesData.length, 'rows');
                    if (notesData.length > 1) {
                        setNotes(gsheets.arrayToObjects(notesData).map(n => ({
                            ...n, id: parseInt(n.id) || Date.now(), author: parseInt(n.author) || currentUser, date: n.date || new Date().toISOString().split('T')[0]
                        })));
                    }
                    // Load categories
                    const categoriesData = await gsheets.readSheet('categories');
                    if (categoriesData.length > 1) {
                        const catObjects = gsheets.arrayToObjects(categoriesData);
                        const reconstructedCats = { courses: [], todos: [], events: [] };
                        catObjects.forEach(cat => {
                            if (reconstructedCats[cat.section]) {
                                reconstructedCats[cat.section].push({ id: cat.id, name: cat.name, emoji: cat.emoji });
                            }
                        });
                        // Only overwrite if we got data (preserve defaults on first use)
                        if (catObjects.length > 0) setCategories(reconstructedCats);
                    }
                    // Load external people
                    const extPeopleData = await gsheets.readSheet('externalPeople');
                    if (extPeopleData.length > 1) {
                        setExternalPeople(gsheets.arrayToObjects(extPeopleData).map(p => ({
                            ...p, id: parseInt(p.id)
                        })));
                    }
                    // Load shared calendar ID from Sheet
                    const sharedCalId = await gsheets.loadCalendarIdFromSheet();
                    if (sharedCalId) {
                        gsheets.calendarId = sharedCalId;
                        setCalendarEnabled(true);
                        console.log('ðŸ“… Calendar ID loaded from Sheet:', sharedCalId);
                    }
                    setLastSync(new Date());
                    setHasLoadedFromCloud(true);
                } catch (error) {
                    console.error('Erreur chargement:', error);
                    if (error.message === 'TOKEN_EXPIRED') {
                        setIsAuthenticated(false);
                        setHasLoadedFromCloud(false);
                    }
                }
                setIsSyncing(false);
            };

            // ===== SYNC TO CLOUD (FIX: notes + endDate + calendarEventId) =====
            const syncToCloud = async () => {
                if (!isAuthenticated) return;
                setIsSyncing(true);
                try {
                    await gsheets.writeSheet('todos', gsheets.objectsToArray(todos, TODOS_HEADERS));
                    await gsheets.writeSheet('courses', gsheets.objectsToArray(courses, COURSES_HEADERS));
                    await gsheets.writeSheet('menus', gsheets.objectsToArray(menus, MENUS_HEADERS));
                    const eventsForSheet = events.map(e => ({ ...e, assignedTo: JSON.stringify(e.assignedTo) }));
                    await gsheets.writeSheet('events', gsheets.objectsToArray(eventsForSheet, EVENTS_HEADERS));
                    await gsheets.writeSheet('guardSchedule', gsheets.objectsToArray(guardSchedule, GUARD_HEADERS));
                    const flatFamilyInfo = [];
                    Object.entries(familyInfo).forEach(([section, items]) => {
                        items.forEach(item => { flatFamilyInfo.push({ section, id: item.id, label: item.label, value: item.value, type: item.type }); });
                    });
                    await gsheets.writeSheet('familyInfo', gsheets.objectsToArray(flatFamilyInfo, FAMILY_HEADERS));
                    await gsheets.writeSheet('notes', gsheets.objectsToArray(notes, NOTES_HEADERS));
                    // Sync categories (flattened)
                    const flatCategories = [];
                    Object.entries(categories).forEach(([section, cats]) => {
                        cats.forEach(cat => { flatCategories.push({ section, id: cat.id, name: cat.name, emoji: cat.emoji }); });
                    });
                    await gsheets.writeSheet('categories', gsheets.objectsToArray(flatCategories, CATEGORIES_HEADERS));
                    // Sync external people
                    await gsheets.writeSheet('externalPeople', gsheets.objectsToArray(externalPeople, EXTERNAL_PEOPLE_HEADERS));
                    setLastSync(new Date());
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                    if (error.message === 'TOKEN_EXPIRED') {
                        setIsAuthenticated(false);
                        setHasLoadedFromCloud(false);
                    }
                }
                setIsSyncing(false);
            };

            const handleGoogleLogout = () => { if (confirm('Se dÃ©connecter de Google ?')) { gsheets.logout(); setIsAuthenticated(false); setCurrentUser(null); setHasLoadedFromCloud(false); } };
            const handleGoogleLogin = async () => {
                const success = await gsheets.requestAuth();
                if (success) {
                    setIsAuthenticated(true);
                    setHasLoadedFromCloud(false);
                    // useEffect [currentUser, isAuthenticated] will trigger syncFromCloud
                }
            };

            // Auto-sync on data changes (only after first cloud load to prevent overwriting)
            useEffect(() => {
                if (isAuthenticated && currentUser && hasLoadedFromCloud) {
                    const timer = setTimeout(() => syncToCloud(), 1000);
                    return () => clearTimeout(timer);
                }
            }, [todos, courses, menus, events, guardSchedule, familyInfo, notes, categories, externalPeople, isAuthenticated, currentUser, hasLoadedFromCloud]);

            // Auto-import calendar events after initial load
            const [calendarImported, setCalendarImported] = useState(false);
            useEffect(() => {
                if (hasLoadedFromCloud && calendarEnabled && !calendarImported && gsheets.calendarId) {
                    setCalendarImported(true);
                    importCalendarEvents();
                }
            }, [hasLoadedFromCloud, calendarEnabled, calendarImported]);

            // ===== HANDLERS =====
            const handleAdd = () => {
                if (addType === 'event' && newItem.title && newItem.date) {
                    const cat = categories.events.find(c => c.id === newItem.category);
                    const newEvent = {
                        id: Date.now(), title: newItem.title, date: newItem.date,
                        endDate: newItem.isPeriod && newItem.endDate ? newItem.endDate : '',
                        time: newItem.isPeriod ? '' : (newItem.time || ''),
                        category: newItem.category || 'general',
                        assignedTo: [newItem.assignedTo || currentUser],
                        emoji: cat ? cat.emoji : 'ðŸ“…', calendarEventId: null,
                        color: newItem.color || ''
                    };
                    setEvents([...events, newEvent]);
                    setShowAddModal(false); resetNewItem(); setAddType('');
                    if (calendarEnabled && gsheets.calendarId) {
                        gsheets.createCalendarEvent(newEvent).then(calId => {
                            if (calId) setEvents(prev => prev.map(e => e.id === newEvent.id ? { ...e, calendarEventId: calId } : e));
                        });
                    }
                } else if (addType === 'todo' && newItem.title) {
                    setTodos([...todos, {
                        id: Date.now(), title: newItem.title, category: newItem.category || 'general',
                        priority: newItem.priority, done: false,
                        assignedTo: newItem.assignedTo !== undefined && newItem.assignedTo !== null ? newItem.assignedTo : null
                    }]);
                    setShowAddModal(false); resetNewItem(); setAddType('');
                } else if (addType === 'course' && newItem.title) {
                    setCourses([...courses, { id: Date.now(), item: newItem.title, category: newItem.category || 'alimentaire', checked: false }]);
                    setNewItem({ ...newItem, title: '' });
                } else if (addType === 'menu' && newItem.title && newItem.day) {
                    setMenus([...menus, { id: Date.now(), day: newItem.day, meal: newItem.title, emoji: 'ðŸ½ï¸' }]);
                    setShowAddModal(false); resetNewItem(); setAddType('');
                }
            };

            // FIX: replace prompt() with modal for unassigned todo toggle
            const toggleTodo = (id) => {
                const todo = todos.find(t => t.id === id);
                if (!todo) return;
                if (!todo.done && !todo.assignedTo) {
                    setAssignPickerTodo(id);
                } else {
                    setTodos(todos.map(t => t.id === id ? { ...t, done: !t.done } : t));
                }
            };
            const confirmAssignTodo = (todoId, userId) => {
                setTodos(todos.map(t => t.id === todoId ? { ...t, done: true, assignedTo: userId } : t));
                setAssignPickerTodo(null);
            };

            const toggleCourse = (id) => setCourses(courses.map(c => c.id === id ? { ...c, checked: !c.checked } : c));

            // NEW: clear all checked courses
            const clearCheckedCourses = () => {
                if (confirm('Supprimer les articles cochÃ©s ?')) {
                    const newCourses = courses.filter(c => !c.checked);
                    setCourses(newCourses);
                    setTimeout(async () => { await gsheets.writeSheet('courses', gsheets.objectsToArray(newCourses, COURSES_HEADERS)); }, 500);
                }
            };

            // FIX: deleteEvent with correct headers + calendar cleanup
            const deleteEvent = (id) => {
                if (confirm('Supprimer cet Ã©vÃ©nement ?')) {
                    const eventToDelete = events.find(e => e.id === id);
                    const newEvents = events.filter(e => e.id !== id);
                    setEvents(newEvents);
                    setTimeout(async () => {
                        const eventsForSheet = newEvents.map(e => ({ ...e, assignedTo: JSON.stringify(e.assignedTo) }));
                        await gsheets.writeSheet('events', gsheets.objectsToArray(eventsForSheet, EVENTS_HEADERS));
                    }, 500);
                    if (calendarEnabled && eventToDelete?.calendarEventId) {
                        gsheets.deleteCalendarEvent(eventToDelete.calendarEventId);
                    }
                }
            };
            const deleteTodo = (id) => {
                if (confirm('Supprimer cette tÃ¢che ?')) {
                    const newTodos = todos.filter(t => t.id !== id);
                    setTodos(newTodos);
                    setTimeout(async () => { await gsheets.writeSheet('todos', gsheets.objectsToArray(newTodos, TODOS_HEADERS)); }, 500);
                }
            };
            const deleteCourse = (id) => {
                if (confirm('Supprimer cet article ?')) {
                    const newCourses = courses.filter(c => c.id !== id);
                    setCourses(newCourses);
                    setTimeout(async () => { await gsheets.writeSheet('courses', gsheets.objectsToArray(newCourses, COURSES_HEADERS)); }, 500);
                }
            };
            const deleteMenu = (id) => {
                if (confirm('Supprimer ce menu ?')) {
                    const newMenus = menus.filter(m => m.id !== id);
                    setMenus(newMenus);
                    setTimeout(async () => { await gsheets.writeSheet('menus', gsheets.objectsToArray(newMenus, MENUS_HEADERS)); }, 500);
                }
            };

            // FIX: notes with controlled state + send button + explicit write
            const addNote = () => {
                if (noteText && noteText.trim().length > 0 && noteText.length <= 300) {
                    const newNotes = [{ id: Date.now(), text: noteText.trim(), author: currentUser, date: new Date().toISOString().split('T')[0] }, ...notes];
                    setNotes(newNotes);
                    setNoteText('');
                    // Explicit write to ensure notes are saved
                    if (isAuthenticated) {
                        console.log('ðŸ“ Writing', newNotes.length, 'notes to sheet...');
                        setTimeout(async () => {
                            try { await gsheets.writeSheet('notes', gsheets.objectsToArray(newNotes, NOTES_HEADERS)); console.log('âœ… Notes saved'); }
                            catch(e) { console.error('âŒ Notes write failed:', e); }
                        }, 300);
                    }
                }
            };
            const deleteNote = (id) => {
                if (confirm('Supprimer cette note ?')) {
                    const newNotes = notes.filter(n => n.id !== id);
                    setNotes(newNotes);
                    if (isAuthenticated) {
                        setTimeout(async () => { await gsheets.writeSheet('notes', gsheets.objectsToArray(newNotes, NOTES_HEADERS)); }, 500);
                    }
                }
            };

            // FIX: familyInfo with React state
            const addFamilyInfo = (section, item) => { setFamilyInfo({ ...familyInfo, [section]: [...familyInfo[section], { ...item, id: Date.now() }] }); };
            const deleteFamilyInfo = (section, id) => { setFamilyInfo({ ...familyInfo, [section]: familyInfo[section].filter(item => item.id !== id) }); };
            const updateFamilyInfo = (section, id, updates) => {
                setFamilyInfo({ ...familyInfo, [section]: familyInfo[section].map(item => item.id === id ? { ...item, ...updates } : item) });
            };
            // Edit todo
            const saveTodoEdit = () => {
                if (!editingTodo) return;
                setTodos(todos.map(t => t.id === editingTodo.id ? { ...t, title: editingTodo.title, priority: editingTodo.priority, assignedTo: editingTodo.assignedTo } : t));
                setEditingTodo(null);
            };

            // Edit event
            const saveEventEdit = () => {
                if (!editingEvent) return;
                const updated = { ...editingEvent };
                setEvents(events.map(e => e.id === updated.id ? { ...e, title: updated.title, date: updated.date, endDate: updated.endDate || '', time: updated.time || '', category: updated.category || '', color: updated.color || '' } : e));
                // Sync to Google Calendar if linked
                if (calendarEnabled && updated.calendarEventId) {
                    gsheets.updateCalendarEvent(updated.calendarEventId, updated);
                }
                setEditingEvent(null);
            };

            // ===== CALENDAR =====
            const enableCalendar = async () => {
                setCalendarStatus('Chargement des calendriers...');
                try {
                    const cals = await gsheets.listCalendars();
                    if (cals.length > 0) {
                        setAvailableCalendars(cals);
                        setShowCalendarPicker(true);
                        setCalendarStatus('');
                    } else {
                        setCalendarStatus('âŒ Aucun calendrier trouvÃ©');
                    }
                } catch (e) { setCalendarStatus('âŒ ' + e.message); }
            };
            const selectCalendar = async (calId, calName) => {
                gsheets.calendarId = calId;
                await gsheets.saveCalendarIdToSheet(calId);
                setCalendarEnabled(true);
                setShowCalendarPicker(false);
                setCalendarStatus(`âœ… "${calName}" â€” import en cours...`);
                // Import events from this calendar
                await importCalendarEvents();
            };
            const importCalendarEvents = async () => {
                if (!gsheets.calendarId) return;
                try {
                    // Fetch 6 months back + 12 months ahead
                    const now = new Date();
                    const timeMin = new Date(now.getFullYear(), now.getMonth() - 6, 1).toISOString();
                    const timeMax = new Date(now.getFullYear(), now.getMonth() + 12, 1).toISOString();
                    const calEvents = await gsheets.fetchCalendarEvents(timeMin, timeMax);
                    console.log(`ðŸ“… Imported ${calEvents.length} events from calendar`);
                    if (calEvents.length === 0) {
                        setCalendarStatus('âœ… Calendrier connectÃ© (0 Ã©vÃ©nements)');
                        return;
                    }
                    // Merge: keep existing events, add new ones from calendar (avoid duplicates by calendarEventId)
                    const existingCalIds = new Set(events.filter(e => e.calendarEventId).map(e => e.calendarEventId));
                    const newEvents = calEvents.filter(e => !existingCalIds.has(e.calendarEventId));
                    if (newEvents.length > 0) {
                        const merged = [...events, ...newEvents.map(e => ({
                            ...e,
                            id: Date.now() + Math.floor(Math.random() * 100000),
                            assignedTo: [],
                            emoji: 'ðŸ“…'
                        }))];
                        setEvents(merged);
                        setCalendarStatus(`âœ… ${newEvents.length} Ã©vÃ©nement(s) importÃ©(s)`);
                    } else {
                        setCalendarStatus('âœ… Calendrier connectÃ© â€” tout est Ã  jour');
                    }
                } catch (e) {
                    console.error('Import error:', e);
                    setCalendarStatus('âš ï¸ Import partiel');
                }
            };
            const disableCalendar = () => {
                if (confirm('DÃ©sactiver la sync Google Calendar ?')) {
                    gsheets.calendarId = null;
                    gsheets.saveCalendarIdToSheet('');
                    setCalendarEnabled(false); setCalendarStatus('');
                }
            };
            const syncEventsToCalendar = async () => {
                if (!calendarEnabled || !gsheets.calendarId) return;
                setCalendarStatus('Sync en cours...');
                let synced = 0;
                const updatedEvents = [...events];
                for (let i = 0; i < updatedEvents.length; i++) {
                    if (!updatedEvents[i].calendarEventId) {
                        const calEventId = await gsheets.createCalendarEvent(updatedEvents[i]);
                        if (calEventId) { updatedEvents[i] = { ...updatedEvents[i], calendarEventId: calEventId }; synced++; }
                    }
                }
                if (synced > 0) { setEvents(updatedEvents); setCalendarStatus(`âœ… ${synced} synchronisÃ©(s)`); }
                else { setCalendarStatus('âœ… Tout est Ã  jour'); }
            };

            // ===== CATEGORY =====
            const handleAddCategory = () => {
                if (!newCatName.trim() || !newCatEmoji || !addCategoryModal) return;
                const id = newCatName.trim().toLowerCase().replace(/\s+/g, '-');
                const section = addCategoryModal.section;
                setCategories({ ...categories, [section]: [...categories[section], { id, name: newCatName.trim(), emoji: newCatEmoji }] });
                setAddCategoryModal(null); setNewCatName(''); setNewCatEmoji('');
            };

            // ===== COMPUTED =====
            const calculateTaskStats = () => {
                const p1 = todos.filter(t => t.assignedTo === 1);
                const p2 = todos.filter(t => t.assignedTo === 2);
                const p1d = p1.filter(t => t.done).length;
                const p2d = p2.filter(t => t.done).length;
                const total = p1.length + p2.length;
                const p1s = total > 0 ? Math.round((p1.length / total) * 100) : 50;
                return {
                    parent1: { total: p1.length, done: p1d, todo: p1.length - p1d, share: p1s },
                    parent2: { total: p2.length, done: p2d, todo: p2.length - p2d, share: 100 - p1s },
                    totalTasks: total, totalDone: p1d + p2d, isBalanced: Math.abs(p1s - 50) <= 10
                };
            };

            const generateGuardWeek = () => {
                const today = new Date();
                const dow = today.getDay();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() + (dow === 0 ? -6 : 1 - dow) + (currentWeekOffset * 7));
                const week = [];
                const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(weekStart); d.setDate(d.getDate() + i);
                    const ds = d.toISOString().split('T')[0];
                    const existing = guardSchedule.find(g => g.date === ds);
                    week.push({
                        date: ds, dayName: dayNames[d.getDay()],
                        displayDate: `${d.getDate()}/${d.getMonth() + 1}`,
                        morning: existing?.morning || null, afternoon: existing?.afternoon || null,
                        notes: existing?.notes || '', id: existing?.id || null,
                        isToday: ds === new Date().toISOString().split('T')[0]
                    });
                }
                return week;
            };

            const updateGuardSlot = (date, period, personId) => {
                const existing = guardSchedule.find(g => g.date === date);
                if (existing) setGuardSchedule(guardSchedule.map(g => g.date === date ? { ...g, [period]: personId } : g));
                else setGuardSchedule([...guardSchedule, { id: Date.now(), date, morning: period === 'morning' ? personId : null, afternoon: period === 'afternoon' ? personId : null, notes: '' }]);
            };
            // NEW: editable guard notes
            const updateGuardNotes = (date, text) => {
                const existing = guardSchedule.find(g => g.date === date);
                if (existing) setGuardSchedule(guardSchedule.map(g => g.date === date ? { ...g, notes: text } : g));
                else setGuardSchedule([...guardSchedule, { id: Date.now(), date, morning: null, afternoon: null, notes: text }]);
            };

            const stats = calculateTaskStats();
            const guardWeek = generateGuardWeek();
            const todayStr = new Date().toISOString().split('T')[0];
            const upcomingEvents = events.filter(e => e.date >= todayStr || (e.endDate && e.endDate >= todayStr)).sort((a, b) => a.date.localeCompare(b.date));
            const sortedEvents = [...events].sort((a, b) => a.date.localeCompare(b.date) || (a.time || '').localeCompare(b.time || ''));

            // ===== LOADING SCREEN =====
            if (isLoading) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center gap-4" style={{background:'var(--bg)'}}>
                        <svg width="64" height="64" viewBox="0 0 40 40"><rect x="6" y="6" width="27" height="27" rx="3" fill="var(--turquoise)" stroke="var(--border)" strokeWidth="1.5" transform="rotate(45 20 20)"/></svg>
                        <h1 className="font-heading text-2xl font-bold" style={{color:'var(--text)'}}>Plateforme Ratours</h1>
                        <div className="loader-dots"><span></span><span></span><span></span></div>
                        <p className="text-sm" style={{color:'var(--text-soft)'}}>Connexion en cours...</p>
                        <span className="text-[10px] opacity-50" style={{color:'var(--text-soft)'}}>{APP_VERSION}</span>
                    </div>
                );
            }

            // ===== LOGIN SCREEN =====
            if (!currentUser) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6" style={{background:'var(--bg)'}}>
                        <div className="nb-card p-8 max-w-md w-full">
                            <div className="text-center mb-8">
                                <div className="mb-4"><svg width="64" height="64" viewBox="0 0 40 40"><rect x="6" y="6" width="27" height="27" rx="3" fill="var(--turquoise)" stroke="var(--border)" strokeWidth="1.5" transform="rotate(45 20 20)"/></svg></div>
                                <h1 className="font-heading text-3xl font-bold mb-2" style={{color:'var(--text)'}}>Plateforme Ratours</h1>
                                <p style={{color:'var(--text-soft)'}}>Qui se connecte ?</p>
                            </div>
                            {isGoogleReady && !isAuthenticated && (
                                <div className="mb-6 p-4 nb-flat" style={{background:'#F0F7F6'}}>
                                    <p className="text-sm mb-3" style={{color:'var(--text)'}}>â˜ï¸ Connectez-vous pour synchroniser</p>
                                    <button onClick={handleGoogleLogin} className="w-full nb-btn px-4 py-3" style={{background:'var(--card)'}}>
                                        <Icon name="cloud" size={20} />
                                        <span className="font-medium">Se connecter avec Google</span>
                                    </button>
                                </div>
                            )}
                            {isAuthenticated && (
                                <div className="mb-6 p-4 nb-flat" style={{background:'#F0F9F0', borderColor:'#8CC63F'}}>
                                    <p className="text-sm mb-2" style={{color:'var(--text)'}}>âœ“ ConnectÃ©</p>
                                    <a href={`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}`} target="_blank" className="text-xs" style={{color:'var(--turquoise)'}}>Ouvrir le Sheet â†’</a>
                                </div>
                            )}
                            <div className="space-y-4">
                                {users.map(user => (
                                    <button key={user.id} onClick={() => setCurrentUser(user.id)} className="w-full nb-btn p-5 flex items-center justify-center gap-3" style={{background: user.color, color: 'white'}}>
                                        <AvatarSVG shape={user.shape} color="rgba(255,255,255,0.85)" size={44} />
                                        <span className="text-2xl font-bold">{user.name}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            const currentUserData = users.find(u => u.id === currentUser);
            const myTodos = todos.filter(t => !t.done && t.assignedTo === currentUser);

            // ===== RECONNECTION SCREEN (user known but token expired) =====
            if (currentUser && !isAuthenticated && !isLoading) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center gap-4 p-6" style={{background:'var(--bg)'}}>
                        <AvatarSVG shape={currentUserData?.shape || 'diamond'} color={currentUserData?.color || 'var(--turquoise)'} size={56} />
                        <h2 className="font-heading text-xl font-bold" style={{color:'var(--text)'}}>Bonjour {currentUserData?.name}</h2>
                        {!reconnectFailed ? (
                            <>
                                <div className="loader-dots"><span></span><span></span><span></span></div>
                                <p className="text-sm text-center" style={{color:'var(--text-soft)'}}>Reconnexion en cours...</p>
                            </>
                        ) : (
                            <>
                                <p className="text-sm text-center" style={{color:'var(--text-soft)'}}>Session expirÃ©e, reconnecte-toi</p>
                                <button onClick={async () => {
                                    setReconnectFailed(false);
                                    try {
                                        const success = await gsheets.requestAuth();
                                        if (success) { setIsAuthenticated(true); }
                                        else { setReconnectFailed(true); }
                                    } catch(e) { setReconnectFailed(true); }
                                }} className="nb-btn px-6 py-3 text-sm" style={{background:'var(--turquoise)', color:'white'}}>
                                    <Icon name="cloud" size={16} /> Se connecter avec Google
                                </button>
                            </>
                        )}
                        <button onClick={() => { setCurrentUser(null); setHasLoadedFromCloud(false); }} className="text-xs underline mt-2" style={{color:'var(--text-soft)'}}>
                            Changer d'utilisateur
                        </button>
                        <span className="text-[10px] opacity-50" style={{color:'var(--text-soft)'}}>{APP_VERSION}</span>
                    </div>
                );
            }

            // Show loader while first cloud sync (only if authenticated)
            if (currentUser && isAuthenticated && !hasLoadedFromCloud) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center gap-4" style={{background:'var(--bg)'}}>
                        <AvatarSVG shape={currentUserData?.shape || 'diamond'} color={currentUserData?.color || 'var(--turquoise)'} size={56} />
                        <h2 className="font-heading text-xl font-bold" style={{color:'var(--text)'}}>Chargement des donnÃ©es...</h2>
                        <div className="loader-dots"><span></span><span></span><span></span></div>
                    </div>
                );
            }

            // ===== MAIN RENDER =====
            return (
                <div className="min-h-screen pb-32" style={{background:'var(--bg)'}}>
                    {/* HEADER */}
                    <div className="p-4 border-b-3" style={{background:'var(--coral)', borderBottom:'3px solid var(--border)'}}>
                        <div className="flex justify-between items-center max-w-4xl mx-auto">
                            <div>
                                <h1 className="font-heading text-xl font-bold text-white">Plateforme Ratours</h1>
                                <p className="text-xs flex items-center gap-1" style={{color:'rgba(255,255,255,0.8)'}}><AvatarSVG shape={currentUserData.shape} color="rgba(255,255,255,0.85)" size={14} /> {currentUserData.name}</p>
                            </div>
                            <div className="flex gap-1.5">
                                {isAuthenticated && (
                                    <button onClick={syncFromCloud} disabled={isSyncing} className="nb-btn px-3 py-1.5 text-xs" style={{background:'rgba(255,255,255,0.9)', color:'var(--text)', borderColor:'var(--border)'}}>
                                        <Icon name="sync" size={14} />
                                        {lastSync && <span>{lastSync.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</span>}
                                    </button>
                                )}
                                <button onClick={() => { setCurrentUser(null); setHasLoadedFromCloud(false); }} className="nb-btn px-2 py-1.5" style={{background:'rgba(255,255,255,0.9)', color:'var(--text)', borderColor:'var(--border)'}}>
                                    <Icon name="logout" size={14} />
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="p-4 max-w-4xl mx-auto">
                        {/* ===== DASHBOARD ===== */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-4">
                                <div className="nb-card p-5" style={{background:'var(--yellow)'}}>
                                    <h2 className="font-heading text-2xl font-bold mb-1" style={{color:'var(--text)'}}>Bonjour {currentUserData.name} ! ðŸ‘‹</h2>
                                    <p className="text-sm" style={{color:'var(--text-soft)'}}>{new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).replace(/^./, s => s.toUpperCase())}</p>
                                </div>
                                
                                {todos.filter(t => !t.done && t.priority === 'high').length > 0 && (
                                    <div className="nb-card p-4" style={{background:'#FFF0F0', borderColor:'#DC2626'}}>
                                        <h3 className="font-bold text-red-700 mb-3 flex items-center gap-2 text-sm">{React.createElement("span", {style:{width:10,height:10,borderRadius:"50%",background:"#ef4444",display:"inline-block"}})} URGENT ({todos.filter(t => !t.done && t.priority === 'high').length})</h3>
                                        {todos.filter(t => !t.done && t.priority === 'high').slice(0, 5).map(todo => (
                                            <div key={todo.id} className="flex items-center gap-3 py-1.5 bg-[var(--card)] rounded-xl px-3 mb-1.5">
                                                <input type="checkbox" className="h-5 w-5 accent-red-500" onChange={() => toggleTodo(todo.id)} />
                                                <span className="flex-1 font-medium text-sm">{todo.title}</span>
                                                {(() => { const u = users.find(ux => ux.id === todo.assignedTo); return u ? React.createElement(AvatarSVG, {shape: u.shape, color: u.color, size: 16}) : 'â“'; })()}
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {upcomingEvents.length > 0 && (
                                    <div className="nb-card p-4">
                                        <h3 className="font-bold text-[var(--text)] mb-3 text-sm">{React.createElement(Icon, {name:"calendar", size:16})} Prochains Ã©vÃ©nements</h3>
                                        {upcomingEvents.slice(0, 4).map(event => (
                                            <div key={event.id} className="flex items-center gap-3 py-2 border-b last:border-0">
                                                {React.createElement(Icon, {name:"calendar", size:20, color:"var(--turquoise)"})}
                                                <div className="flex-1 min-w-0">
                                                    <span className="font-medium text-sm block truncate">{event.title}</span>
                                                    <span className="text-xs text-[var(--text-soft)]">
                                                        {formatDateFr(event.date)}
                                                        {event.endDate && ` â†’ ${formatDateFr(event.endDate)}`}
                                                        {event.time && ` Ã  ${event.time}`}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                        {upcomingEvents.length > 4 && <button onClick={() => setActiveTab('calendar')} className="text-xs text-[var(--text)] mt-2">Voir tout â†’</button>}
                                    </div>
                                )}
                                
                                <div className="nb-card p-4">
                                    <h3 className="font-bold text-[var(--text)] mb-3 text-sm">{React.createElement(Icon, {name:"check", size:16})} Mes tÃ¢ches ({myTodos.length})</h3>
                                    {myTodos.slice(0, 5).map(todo => (
                                        <div key={todo.id} className="flex items-center gap-3 py-1.5">
                                            <input type="checkbox" className="h-5 w-5" onChange={() => toggleTodo(todo.id)} />
                                            <span className="text-sm">{todo.title}</span>
                                        </div>
                                    ))}
                                    {myTodos.length === 0 && <p className="text-sm text-[var(--text-soft)]">Rien pour l'instant {React.createElement(Icon, {name:"check", size:14, color:"var(--green)"})}</p>}
                                </div>

                                <div className="nb-card p-4">
                                    <h3 className="font-bold text-[var(--text)] mb-3 text-sm">{React.createElement(Icon, {name:"cart", size:22})} Courses ({courses.filter(c => !c.checked).length})</h3>
                                    {courses.filter(c => !c.checked).slice(0, 6).map(course => (
                                        <div key={course.id} className="flex items-center gap-3 py-1">
                                            <input type="checkbox" className="h-4 w-4" onChange={() => toggleCourse(course.id)} />
                                            <span className="text-sm">{course.item}</span>
                                        </div>
                                    ))}
                                </div>
                                
                                {notes.length > 0 && (
                                    <div className="nb-card p-4">
                                        <h3 className="font-bold text-[var(--text)] mb-3 text-sm">{React.createElement(Icon, {name:"notes", size:16})} DerniÃ¨res notes</h3>
                                        {notes.slice(0, 3).map(note => (
                                            <div key={note.id} className="py-2 border-b last:border-0">
                                                <div className="flex items-center gap-2 mb-0.5">
                                                    {(() => { const u = users.find(ux => ux.id === note.author); return u ? React.createElement(AvatarSVG, {shape: u.shape, color: u.color, size: 20}) : 'ðŸ‘¤'; })()}
                                                    <span className="text-xs font-semibold">{users.find(u => u.id === note.author)?.name}</span>
                                                    <span className="text-xs text-[var(--text-soft)]">{formatDateFr(note.date)}</span>
                                                </div>
                                                <p className="text-sm text-[var(--text)] line-clamp-2">{note.text}</p>
                                            </div>
                                        ))}
                                        {notes.length > 3 && <button onClick={() => setActiveTab('notes')} className="text-xs text-[var(--text)] mt-2">Voir toutes â†’</button>}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* ===== AGENDA (sorted, formatted, periods, assignees) ===== */}
                        {activeTab === 'calendar' && (() => {
                            const now = new Date();
                            const viewDate = new Date(now.getFullYear(), now.getMonth() + calendarMonthOffset, 1);
                            const viewYear = viewDate.getFullYear();
                            const viewMonth = viewDate.getMonth();
                            const monthName = viewDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                            // Filter events visible in this month
                            const monthEvents = sortedEvents.filter(e => {
                                const startDate = new Date(e.date + 'T12:00:00');
                                const endDate = e.endDate ? new Date(e.endDate + 'T12:00:00') : startDate;
                                const monthStart = new Date(viewYear, viewMonth, 1);
                                const monthEnd = new Date(viewYear, viewMonth + 1, 0);
                                return startDate <= monthEnd && endDate >= monthStart;
                            });
                            return (
                            <div className="space-y-3">
                                <div className="flex items-center justify-between">
                                    <h2 className="font-heading text-2xl font-bold" style={{color:'var(--text)'}}>{React.createElement(Icon, {name:"calendar", size:22})} Agenda</h2>
                                    {calendarEnabled && <span className="text-xs bg-[var(--bg)] text-[var(--text)] px-2 py-1 rounded-full">{React.createElement(Icon, {name:"calendar", size:12})} Cal.</span>}
                                </div>
                                {/* Month navigation */}
                                <div className="nb-card flex items-center justify-between p-3">
                                    <button onClick={() => setCalendarMonthOffset(calendarMonthOffset - 1)} className="nb-btn px-3 py-1.5 text-sm" style={{background:'var(--card)'}}>â†</button>
                                    <div className="text-center">
                                        <span className="font-bold text-[var(--text)] capitalize">{monthName}</span>
                                        <span className="text-xs text-[var(--text-soft)] ml-2">({monthEvents.length})</span>
                                    </div>
                                    <div className="flex gap-1.5">
                                        {calendarMonthOffset !== 0 && <button onClick={() => setCalendarMonthOffset(0)} className="nb-btn px-2.5 py-1.5 text-xs" style={{background:'var(--turquoise)', color:'white'}}>Auj.</button>}
                                        <button onClick={() => setCalendarMonthOffset(calendarMonthOffset + 1)} className="nb-btn px-3 py-1.5 text-sm" style={{background:'var(--card)'}}>â†’</button>
                                    </div>
                                </div>
                                {monthEvents.map(event => {
                                    const isPeriod = !!event.endDate;
                                    const dayCount = isPeriod ? Math.ceil((new Date(event.endDate + 'T12:00:00') - new Date(event.date + 'T12:00:00')) / 86400000) + 1 : 0;
                                    const evColor = EVENT_COLORS.find(c => c.id === event.color);
                                    return (
                                        <div key={event.id} className="nb-card p-4 flex items-start gap-3" style={evColor ? {borderLeftWidth:'5px', borderLeftColor: evColor.hex} : {}}>
                                            {evColor ? <span className="cdot" style={{background: evColor.hex}}></span> : React.createElement(Icon, {name:"calendar", size:22, color:"var(--turquoise)"})}
                                            <div className="flex-1 min-w-0">
                                                <h3 className="font-bold text-sm" style={{color:'var(--text)'}}>{event.title}</h3>
                                                <p className="text-xs mt-0.5" style={{color:'var(--text-soft)'}}>
                                                    {isPeriod ? (
                                                        <span>{formatDateFr(event.date)} â†’ {formatDateFr(event.endDate)} <span className="nb-tag ml-1">{dayCount}j</span></span>
                                                    ) : (
                                                        <span>{formatDateFr(event.date)}{event.time && ` Ã  ${event.time}`}</span>
                                                    )}
                                                </p>
                                                {event.assignedTo?.length > 0 && (
                                                    <div className="flex gap-1 mt-1.5 flex-wrap">{event.assignedTo.map(uid => {
                                                        const u = allPeople.find(p => p.id === uid);
                                                        return u ? React.createElement('span', {key: uid, className: "nb-tag"}, React.createElement(AvatarSVG, {shape: u.shape || 'circle', color: u.color || 'var(--turquoise)', size: 12}), ' ', u.name) : null;
                                                    })}</div>
                                                )}
                                            </div>
                                            <div className="flex flex-col items-center gap-1.5">
                                                {event.calendarEventId && React.createElement(Icon, {name:"cloud", size:12, color:"var(--green)"})}
                                                <button onClick={() => setEditingEvent({...event})} style={{color:'var(--text-soft)'}}><Icon name="edit" size={14} /></button>
                                                <button onClick={() => deleteEvent(event.id)} className="text-red-400"><Icon name="x" size={14} /></button>
                                            </div>
                                        </div>
                                    );
                                })}
                                {monthEvents.length === 0 && <div className="nb-card p-8 text-center text-sm" style={{color:'var(--text-soft)'}}>Aucun Ã©vÃ©nement ce mois-ci</div>}
                            </div>
                            );
                        })()}

                        {/* ===== TÃ‚CHES (toggle done, show priority + assignee) ===== */}
                        {activeTab === 'todos' && (
                            <div className="space-y-3">
                                <div className="flex items-center justify-between">
                                    <h2 className="font-heading text-2xl font-bold" style={{color:'var(--text)'}}>{React.createElement(Icon, {name:"check", size:22})} TÃ¢ches</h2>
                                    <button onClick={() => setHideDoneTodos(!hideDoneTodos)} className={`text-xs px-3 py-1.5 rounded-full ${hideDoneTodos ? 'bg-[var(--bg)] text-[var(--text)]' : 'bg-gray-100 text-[var(--text-soft)]'}`}>
                                        {hideDoneTodos ? 'ðŸ‘ï¸ Voir terminÃ©es' : 'ðŸ™ˆ Masquer faites'}
                                    </button>
                                </div>
                                
                                {(() => {
                                    const unassigned = todos.filter(t => !t.assignedTo && (!hideDoneTodos || !t.done));
                                    return unassigned.length > 0 ? (
                                        <div className="nb-card p-4 border-2 border-yellow-300">
                                            <h3 className="font-bold text-[var(--text)] mb-2 text-sm">â“ Non assignÃ©es ({unassigned.length})</h3>
                                            {unassigned.map(todo => (
                                                <div key={todo.id} className="flex items-center justify-between py-2 border-b last:border-0">
                                                    <div className="flex items-center gap-3 flex-1">
                                                        <input type="checkbox" checked={todo.done} onChange={() => toggleTodo(todo.id)} className="h-5 w-5" />
                                                        <span className={`text-sm ${todo.done ? 'line-through text-[var(--text-soft)]' : ''}`}>{todo.title}</span>
                                                    </div>
                                                    <div className="flex items-center gap-1.5">
                                                        {todo.priority === 'high' && <span style={{width:8,height:8,borderRadius:'50%',background:'#ef4444',display:'inline-block'}}></span>}
                                                        {todo.priority === 'medium' && <span style={{width:8,height:8,borderRadius:'50%',background:'#eab308',display:'inline-block'}}></span>}
                                                        <button onClick={() => setEditingTodo({id: todo.id, title: todo.title, priority: todo.priority || '', assignedTo: todo.assignedTo || ''})} className="text-[var(--text-soft)]"><Icon name="edit" size={14} /></button>
                                                        <button onClick={() => deleteTodo(todo.id)} className="text-red-400"><Icon name="x" size={14} /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : null;
                                })()}
                                
                                {categories.todos.map(cat => {
                                    const catTodos = todos.filter(t => t.category === cat.id && t.assignedTo && (!hideDoneTodos || !t.done));
                                    if (catTodos.length === 0) return null;
                                    return (
                                        <div key={cat.id} className="nb-card p-4">
                                            <h3 className="font-bold text-[var(--text)] mb-2 flex items-center gap-2 text-sm">{cat.emoji} {cat.name}</h3>
                                            {catTodos.map(todo => (
                                                <div key={todo.id} className="flex items-center justify-between py-2 border-b last:border-0">
                                                    <div className="flex items-center gap-3 flex-1">
                                                        <input type="checkbox" checked={todo.done} onChange={() => toggleTodo(todo.id)} className="h-5 w-5" />
                                                        <span className={`text-sm ${todo.done ? 'line-through text-[var(--text-soft)]' : ''}`}>{todo.title}</span>
                                                    </div>
                                                    <div className="flex items-center gap-1.5">
                                                        {todo.priority === 'high' && <span style={{width:8,height:8,borderRadius:'50%',background:'#ef4444',display:'inline-block'}}></span>}
                                                        {todo.priority === 'medium' && <span style={{width:8,height:8,borderRadius:'50%',background:'#eab308',display:'inline-block'}}></span>}
                                                        {(() => { const u = users.find(u => u.id === todo.assignedTo); return u ? React.createElement(AvatarSVG, {shape: u.shape, color: u.color, size: 16}) : null; })()}
                                                        <button onClick={() => setEditingTodo({id: todo.id, title: todo.title, priority: todo.priority || '', assignedTo: todo.assignedTo || ''})} className="text-[var(--text-soft)]"><Icon name="edit" size={14} /></button>
                                                        <button onClick={() => deleteTodo(todo.id)} className="text-red-400 ml-1"><Icon name="x" size={14} /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    );
                                })}

                                {/* Catch-all: assigned todos whose category isn't in the list */}
                                {(() => {
                                    const knownCatIds = categories.todos.map(c => c.id);
                                    const orphans = todos.filter(t => t.assignedTo && !knownCatIds.includes(t.category) && (!hideDoneTodos || !t.done));
                                    return orphans.length > 0 ? (
                                        <div className="nb-card p-4">
                                            <h3 className="font-bold text-[var(--text)] mb-2 flex items-center gap-2 text-sm">{React.createElement(Icon, {name:"check", size:14})} Autres</h3>
                                            {orphans.map(todo => (
                                                <div key={todo.id} className="flex items-center justify-between py-2 border-b last:border-0">
                                                    <div className="flex items-center gap-3 flex-1">
                                                        <input type="checkbox" checked={todo.done} onChange={() => toggleTodo(todo.id)} className="h-5 w-5" />
                                                        <span className={`text-sm ${todo.done ? 'line-through text-[var(--text-soft)]' : ''}`}>{todo.title}</span>
                                                    </div>
                                                    <div className="flex items-center gap-1.5">
                                                        {todo.priority === 'high' && <span style={{width:8,height:8,borderRadius:'50%',background:'#ef4444',display:'inline-block'}}></span>}
                                                        {todo.priority === 'medium' && <span style={{width:8,height:8,borderRadius:'50%',background:'#eab308',display:'inline-block'}}></span>}
                                                        {(() => { const u = users.find(u => u.id === todo.assignedTo); return u ? React.createElement(AvatarSVG, {shape: u.shape, color: u.color, size: 16}) : null; })()}
                                                        <button onClick={() => setEditingTodo({id: todo.id, title: todo.title, priority: todo.priority || '', assignedTo: todo.assignedTo || ''})} className="text-[var(--text-soft)]"><Icon name="edit" size={14} /></button>
                                                        <button onClick={() => deleteTodo(todo.id)} className="text-red-400 ml-1"><Icon name="x" size={14} /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : null;
                                })()}

                                {todos.length === 0 && <div className="bg-gray-50 rounded-2xl p-8 text-center text-[var(--text-soft)] text-sm">Aucune tÃ¢che â€” ajoutez-en via le bouton +</div>}
                            </div>
                        )}

                        {/* ===== COURSES (with clear checked) ===== */}
                        {activeTab === 'courses' && (
                            <div className="space-y-3">
                                <div className="flex items-center justify-between">
                                    <h2 className="font-heading text-2xl font-bold" style={{color:'var(--text)'}}>{React.createElement(Icon, {name:"cart", size:22})} Courses</h2>
                                    {courses.some(c => c.checked) && (
                                        <button onClick={clearCheckedCourses} className="text-xs bg-red-50 text-red-600 px-3 py-1.5 rounded-full border border-red-200">
                                            ðŸ—‘ï¸ Vider cochÃ©s ({courses.filter(c => c.checked).length})
                                        </button>
                                    )}
                                </div>
                                {categories.courses.map(cat => {
                                    const catCourses = courses.filter(c => c.category === cat.id);
                                    if (catCourses.length === 0) return null;
                                    const unchecked = catCourses.filter(c => !c.checked).length;
                                    return (
                                        <div key={cat.id} className="nb-card p-4">
                                            <h3 className="font-bold text-[var(--text)] mb-2 flex items-center gap-2 text-sm">
                                                {cat.emoji} {cat.name} <span className="text-xs text-[var(--text-soft)] font-normal">({unchecked})</span>
                                            </h3>
                                            {catCourses.map(course => (
                                                <div key={course.id} className="flex items-center justify-between py-1.5 border-b last:border-0">
                                                    <div className="flex items-center gap-3 flex-1">
                                                        <input type="checkbox" checked={course.checked} onChange={() => toggleCourse(course.id)} className="h-5 w-5" />
                                                        <span className={`text-sm ${course.checked ? 'line-through text-[var(--text-soft)]' : ''}`}>{course.item}</span>
                                                    </div>
                                                    <button onClick={() => deleteCourse(course.id)} className="text-red-400"><Icon name="x" size={14} /></button>
                                                </div>
                                            ))}
                                        </div>
                                    );
                                })}
                                {courses.length === 0 && <div className="bg-gray-50 rounded-2xl p-8 text-center text-[var(--text-soft)] text-sm">Aucune course â€” ajoutez-en via le bouton +</div>}
                            </div>
                        )}

                        {/* ===== MENUS (grouped by day) ===== */}
                        {activeTab === 'menus' && (
                            <div className="space-y-3">
                                <h2 className="font-heading text-2xl font-bold" style={{color:'var(--text)'}}>{React.createElement(Icon, {name:"chef", size:22})} Menus</h2>
                                {DAY_ORDER.map(day => {
                                    const dayMenus = menus.filter(m => m.day === day);
                                    if (dayMenus.length === 0) return null;
                                    return (
                                        <div key={day} className="nb-card p-4">
                                            <h3 className="font-bold text-[var(--text)] mb-2 text-sm">{day}</h3>
                                            {dayMenus.map(m => (
                                                <div key={m.id} className="flex items-center justify-between py-1.5 border-b last:border-0">
                                                    <div className="flex items-center gap-2">
                                                        {React.createElement(Icon, {name:"chef", size:20, color:"var(--turquoise)"})}
                                                        <span className="text-sm">{m.meal}</span>
                                                    </div>
                                                    <button onClick={() => deleteMenu(m.id)} className="text-red-400"><Icon name="x" size={14} /></button>
                                                </div>
                                            ))}
                                        </div>
                                    );
                                })}
                                {menus.length === 0 && <div className="bg-gray-50 rounded-2xl p-8 text-center text-[var(--text-soft)] text-sm">Aucun menu planifiÃ©</div>}
                            </div>
                        )}

                        {/* ===== STATS ===== */}
                        {activeTab === 'stats' && (
                            <div className="space-y-4">
                                <h2 className="font-heading text-2xl font-bold" style={{color:'var(--text)'}}>{React.createElement(Icon, {name:"chart", size:22})} Statistiques</h2>
                                <div className="bg-[var(--bg)] rounded-lg p-5 border-2 border-[var(--border)]">
                                    <h3 className="text-lg font-bold mb-3">âš–ï¸ Ã‰quilibre parental</h3>
                                    {stats.isBalanced && stats.totalTasks > 0 && (
                                        <div className="bg-green-100 border border-green-300 rounded-xl p-2 mb-3">
                                            <p className="text-green-800 font-medium text-sm">{React.createElement(Icon, {name:"check", size:16, color:"#16a34a"})} Charge bien rÃ©partie !</p>
                                        </div>
                                    )}
                                    <div className="flex justify-between mb-2 text-sm">
                                        <span className="font-semibold text-[var(--turquoise)]">{React.createElement(AvatarSVG, {shape: users[0].shape, color: users[0].color, size: 16})} {users[0].name}: {stats.parent1.share}%</span>
                                        <span className="font-semibold text-[var(--text)]">{React.createElement(AvatarSVG, {shape: users[1].shape, color: users[1].color, size: 16})} {users[1].name}: {stats.parent2.share}%</span>
                                    </div>
                                    <div className="w-full h-10 bg-gray-200 rounded-full overflow-hidden flex">
                                        <div className="h-full flex" style={{ width: `${stats.parent1.share}%` }}>
                                            <div className="bg-[var(--turquoise)] flex items-center justify-center text-white text-xs font-bold" style={{ width: stats.parent1.total > 0 ? `${(stats.parent1.done / stats.parent1.total) * 100}%` : '0%' }}>{stats.parent1.done > 0 && `âœ“${stats.parent1.done}`}</div>
                                            <div className="bg-[#B0E0DB] flex items-center justify-center text-[#2D8A7E] text-xs" style={{ width: stats.parent1.total > 0 ? `${(stats.parent1.todo / stats.parent1.total) * 100}%` : '0%' }}>{stats.parent1.todo > 0 && stats.parent1.todo}</div>
                                        </div>
                                        <div className="h-full flex" style={{ width: `${stats.parent2.share}%` }}>
                                            <div className="bg-[var(--bg)] flex items-center justify-center text-[var(--text)] text-xs" style={{ width: stats.parent2.total > 0 ? `${(stats.parent2.todo / stats.parent2.total) * 100}%` : '0%' }}>{stats.parent2.todo > 0 && stats.parent2.todo}</div>
                                            <div className="bg-[var(--lavender)] flex items-center justify-center text-white text-xs font-bold" style={{ width: stats.parent2.total > 0 ? `${(stats.parent2.done / stats.parent2.total) * 100}%` : '0%' }}>{stats.parent2.done > 0 && `âœ“${stats.parent2.done}`}</div>
                                        </div>
                                    </div>
                                    <p className="text-center mt-3 bg-[var(--card)] rounded-xl p-2 text-sm font-medium">{stats.totalDone} / {stats.totalTasks} tÃ¢ches accomplies</p>
                                </div>
                            </div>
                        )}

                        {/* ===== GARDE (with editable notes) ===== */}
                        {activeTab === 'guard' && (
                            <div className="space-y-3">
                                <div className="flex items-center justify-between">
                                    <h2 className="font-heading text-2xl font-bold" style={{color:'var(--text)'}}>{React.createElement(Icon, {name:"baby", size:22})} Garde</h2>
                                    <div className="flex gap-1.5">
                                        <button onClick={() => setCurrentWeekOffset(currentWeekOffset - 1)} className="bg-[var(--bg)] px-2.5 py-1.5 rounded-lg text-xs font-medium">â†</button>
                                        <button onClick={() => setCurrentWeekOffset(0)} className="bg-[var(--turquoise)] text-white px-2.5 py-1.5 rounded-lg text-xs font-medium">Auj.</button>
                                        <button onClick={() => setCurrentWeekOffset(currentWeekOffset + 1)} className="bg-[var(--bg)] px-2.5 py-1.5 rounded-lg text-xs font-medium">â†’</button>
                                    </div>
                                </div>
                                {guardWeek.map(day => (
                                    <div key={day.date} className={`nb-card p-4 ${day.isToday ? 'ring-2 ring-[var(--turquoise)]' : ''}`}>
                                        <h3 className="font-bold text-sm mb-2">
                                            {day.dayName} {day.displayDate}
                                            {day.isToday && <span className="ml-2 text-xs bg-[var(--turquoise)] text-white px-2 py-0.5 rounded-full">Auj.</span>}
                                        </h3>
                                        <div className="grid grid-cols-2 gap-2 mb-2">
                                            <div className="bg-amber-50 rounded-xl p-2.5">
                                                <p className="text-xs text-amber-700 mb-1 font-medium">â˜€ï¸ Matin</p>
                                                <select value={day.morning || ''} onChange={(e) => updateGuardSlot(day.date, 'morning', parseInt(e.target.value))} className="w-full bg-[var(--card)] border border-[var(--border)] rounded-lg px-2 py-1 text-xs">
                                                    <option value="">â€”</option>
                                                    {allPeople.map(p => <option key={p.id} value={p.id}>{p.emoji} {p.name}</option>)}
                                                </select>
                                            </div>
                                            <div className="bg-indigo-50 rounded-xl p-2.5">
                                                <p className="text-xs text-indigo-700 mb-1 font-medium">ðŸŒ™ AprÃ¨s-midi</p>
                                                <select value={day.afternoon || ''} onChange={(e) => updateGuardSlot(day.date, 'afternoon', parseInt(e.target.value))} className="w-full bg-[var(--card)] border border-[var(--border)] rounded-lg px-2 py-1 text-xs">
                                                    <option value="">â€”</option>
                                                    {allPeople.map(p => <option key={p.id} value={p.id}>{p.emoji} {p.name}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <input type="text" placeholder="Notes du jour..." value={day.notes} onChange={(e) => updateGuardNotes(day.date, e.target.value)} className="w-full text-xs bg-gray-50 border rounded-lg px-2.5 py-1.5 placeholder-gray-400" />
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* ===== NOTES (controlled + send button) ===== */}
                        {activeTab === 'notes' && (
                            <div className="space-y-3">
                                <h2 className="font-heading text-2xl font-bold" style={{color:'var(--text)'}}>{React.createElement(Icon, {name:"notes", size:22})} Notes</h2>
                                <div className="nb-card p-4">
                                    <textarea
                                        placeholder="Ã‰crivez une note (max 300 car.)..."
                                        maxLength="300" rows="2"
                                        className="w-full px-3 py-2 border-2 rounded-xl resize-none text-sm"
                                        value={noteText}
                                        onChange={(e) => setNoteText(e.target.value)}
                                        onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addNote(); } }}
                                    />
                                    <div className="flex justify-between items-center mt-2">
                                        <span className="text-xs text-[var(--text-soft)]">{noteText.length}/300</span>
                                        <button onClick={addNote} disabled={!noteText.trim()} className={`px-4 py-1.5 rounded-lg text-xs font-medium ${noteText.trim() ? 'bg-[var(--turquoise)] text-white' : 'bg-gray-100 text-[var(--text-soft)]'}`}>
                                            Envoyer
                                        </button>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    {notes.map(note => (
                                        <div key={note.id} className="nb-card p-4">
                                            <div className="flex justify-between items-start mb-1">
                                                <div className="flex items-center gap-2">
                                                    {(() => { const u = users.find(ux => ux.id === note.author); return u ? React.createElement(AvatarSVG, {shape: u.shape, color: u.color, size: 24}) : 'ðŸ‘¤'; })()}
                                                    <span className="text-sm font-semibold">{users.find(u => u.id === note.author)?.name || 'Inconnu'}</span>
                                                    <span className="text-xs text-[var(--text-soft)]">{formatDateFr(note.date)}</span>
                                                </div>
                                                <button onClick={() => deleteNote(note.id)} className="text-red-400"><Icon name="x" size={14} /></button>
                                            </div>
                                            <p className="text-sm text-[var(--text)] whitespace-pre-wrap">{note.text}</p>
                                        </div>
                                    ))}
                                    {notes.length === 0 && <div className="bg-gray-50 rounded-2xl p-8 text-center text-[var(--text-soft)] text-sm">Aucune note</div>}
                                </div>
                            </div>
                        )}

                        {/* ===== FAMILY (React state for modal) ===== */}
                        {activeTab === 'family' && (
                            <div className="space-y-3">
                                <h2 className="font-heading text-2xl font-bold" style={{color:'var(--text)'}}>{React.createElement(Icon, {name:"users", size:22})} Infos Famille</h2>
                                {[
                                    { key: 'urgences', title: 'Urgences', type: 'phone', iconName: 'heart' },
                                    { key: 'utiles', title: 'NumÃ©ros utiles', type: 'phone', iconName: 'heart' },
                                    { key: 'links', title: 'Liens', type: 'link', iconName: 'search' },
                                    { key: 'notes', title: 'Notes', type: 'text', iconName: 'notes' },
                                ].map(section => (
                                    <div key={section.key} className="nb-card p-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="font-bold text-sm flex items-center gap-1"><Icon name={section.iconName} size={14} /> {section.title}</h3>
                                            <button onClick={() => { setEditingInfo({ section: section.key, type: section.type }); setInfoLabel(''); setInfoValue(''); }} className="bg-[var(--bg)] text-[var(--text)] px-2.5 py-1 rounded-lg text-xs font-medium">+ Ajouter</button>
                                        </div>
                                        {familyInfo[section.key].map(item => (
                                            <div key={item.id} className="py-2 border-b last:border-0 flex justify-between items-center">
                                                <div className="flex-1 min-w-0">
                                                    <span className="text-sm font-medium text-[var(--text)]">{item.label}</span>
                                                    {section.type === 'link' ? (
                                                        <a href={item.value} target="_blank" rel="noopener noreferrer" className="text-xs text-[var(--text)] hover:underline block truncate">{item.value}</a>
                                                    ) : (
                                                        <span className="text-xs text-[var(--text-soft)] block">{item.value}</span>
                                                    )}
                                                </div>
                                                <button onClick={() => { setEditingInfo({ section: section.key, type: section.type, editId: item.id }); setInfoLabel(item.label); setInfoValue(item.value); }} className="text-[var(--text-soft)] ml-1"><Icon name="edit" size={14} /></button>
                                                <button onClick={() => deleteFamilyInfo(section.key, item.id)} className="text-red-400 ml-1"><Icon name="trash" size={14} /></button>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                                {editingInfo && (
                                    <div className="nb-overlay" onClick={(e) => { if (e.target === e.currentTarget) setEditingInfo(null); }}>
                                        <div className="nb-modal">
                                            <h3 className="text-lg font-bold mb-3">{editingInfo.editId ? 'Modifier' : 'Ajouter'}</h3>
                                            <input type="text" placeholder="Label" value={infoLabel} onChange={(e) => setInfoLabel(e.target.value)} className="w-full px-4 py-3 border-2 rounded-xl mb-3 text-sm" autoFocus />
                                            <input type={editingInfo.type === 'link' ? 'url' : 'text'} placeholder={editingInfo.type === 'phone' ? 'TÃ©lÃ©phone' : editingInfo.type === 'link' ? 'URL' : 'Texte'} value={infoValue} onChange={(e) => setInfoValue(e.target.value)} className="w-full px-4 py-3 border-2 rounded-xl mb-4 text-sm" />
                                            <div className="flex gap-3">
                                                <button onClick={() => setEditingInfo(null)} className="flex-1 nb-btn py-3 text-sm" style={{background:"var(--card)"}}>Annuler</button>
                                                <button onClick={() => { if (infoLabel && infoValue) { if (editingInfo.editId) { updateFamilyInfo(editingInfo.section, editingInfo.editId, { label: infoLabel, value: infoValue }); } else { addFamilyInfo(editingInfo.section, { label: infoLabel, value: infoValue, type: editingInfo.type }); } setEditingInfo(null); } }} className="flex-1 nb-btn py-3 text-sm" style={{background:"var(--turquoise)", color:"white"}}>{editingInfo.editId ? 'Enregistrer' : 'Ajouter'}</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* ===== SETTINGS ===== */}
                        {activeTab === 'settings' && (
                            <div className="space-y-3">
                                <h2 className="font-heading text-2xl font-bold" style={{color:'var(--text)'}}>{React.createElement(Icon, {name:"settings", size:22})} RÃ©glages</h2>
                                
                                {/* Google Calendar */}
                                <div className="nb-card p-4">
                                    <h3 className="font-bold text-sm flex items-center gap-2 mb-3">{React.createElement(Icon, {name:"calendar", size:16})} Google Calendar</h3>
                                    <p className="text-xs text-[var(--text-soft)] mb-3">SÃ©lectionne un calendrier existant pour synchroniser les Ã©vÃ©nements</p>
                                    {!calendarEnabled ? (
                                        <button onClick={enableCalendar} className="w-full bg-[var(--turquoise)] text-[var(--text)] py-2.5 rounded-xl text-sm font-medium">{React.createElement(Icon, {name:"calendar", size:14})} Choisir un calendrier</button>
                                    ) : (
                                        <div className="space-y-2">
                                            <div className="flex items-center gap-2 bg-green-50 rounded-xl p-2.5">{React.createElement(Icon, {name:"check", size:14, color:"#16a34a"})}<span className="text-green-800 text-xs font-medium">Calendrier connectÃ©</span></div>
                                            <button onClick={importCalendarEvents} className="w-full bg-[var(--card)] text-[var(--text)] py-2 rounded-xl text-xs font-medium">{React.createElement(Icon, {name:"cloud", size:14})} Importer depuis le calendrier</button>
                                            <button onClick={syncEventsToCalendar} className="w-full bg-[var(--card)] text-[var(--text)] py-2 rounded-xl text-xs font-medium">{React.createElement(Icon, {name:"sync", size:14})} Pousser vers le calendrier</button>
                                            <button onClick={enableCalendar} className="w-full bg-[var(--card)] text-[var(--text)] py-1.5 rounded-xl text-xs font-medium">{React.createElement(Icon, {name:"edit", size:14})} Changer de calendrier</button>
                                            <button onClick={disableCalendar} className="w-full bg-gray-100 text-[var(--text-soft)] py-1.5 rounded-xl text-xs">DÃ©sactiver</button>
                                        </div>
                                    )}
                                    {calendarStatus && <p className="text-xs text-[var(--text)] mt-2 text-center">{calendarStatus}</p>}
                                </div>

                                {/* Personnes externes */}
                                <div className="nb-card p-4">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold text-sm">{React.createElement(Icon, {name:"users", size:16})} Personnes externes</h3>
                                        <button onClick={() => { setAddPersonModal(true); setNewPersonName(''); setNewPersonEmoji(''); }} className="bg-[var(--bg)] text-[var(--text)] px-2.5 py-1 rounded-lg text-xs font-medium">+ Ajouter</button>
                                    </div>
                                    {externalPeople.map(person => (
                                        <div key={person.id} className="py-2 border-b last:border-0 flex justify-between items-center">
                                            <div className="flex items-center gap-2"><span className="text-lg">{person.emoji}</span><span className="text-sm font-medium">{person.name}</span></div>
                                            <button onClick={() => setExternalPeople(externalPeople.filter(p => p.id !== person.id))} className="text-red-400"><Icon name="trash" size={14} /></button>
                                        </div>
                                    ))}
                                </div>

                                {/* Categories with emoji modal */}
                                {[
                                    { section: 'courses', title: 'CatÃ©gories Courses', icon: 'cart' },
                                    { section: 'todos', title: 'CatÃ©gories TÃ¢ches', icon: 'check' },
                                    { section: 'events', title: 'CatÃ©gories Ã‰vÃ©nements', icon: 'calendar' },
                                ].map(({ section, title, icon }) => (
                                    <div key={section} className="nb-card p-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="font-bold text-sm flex items-center gap-1.5"><Icon name={icon} size={16} /> {title}</h3>
                                            <button onClick={() => { setAddCategoryModal({ section }); setNewCatName(''); setNewCatEmoji(''); }} className="bg-[var(--bg)] text-[var(--text)] px-2.5 py-1 rounded-lg text-xs font-medium">+ Ajouter</button>
                                        </div>
                                        {categories[section].map(cat => (
                                            <div key={cat.id} className="py-2 border-b last:border-0 flex justify-between items-center">
                                                <div className="flex items-center gap-2"><span className="text-lg">{cat.emoji}</span><span className="text-sm">{cat.name}</span></div>
                                                <button onClick={() => setCategories({ ...categories, [section]: categories[section].filter(c => c.id !== cat.id) })} className="text-red-400"><Icon name="trash" size={14} /></button>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* ===== FAB ===== */}
                    <button onClick={() => setShowAddModal(true)} className="fixed bottom-28 right-4 rounded-full p-3.5 hover:scale-110 transition-transform z-40" style={{background:'var(--green)', color:'white', border:'2.5px solid var(--border)', boxShadow:'3px 3px 0 var(--border)'}}>
                        <Icon name="plus" size={24} />
                    </button>

                    {/* ===== ADD ITEM MODAL (bottom-sheet on mobile) ===== */}
                    {showAddModal && (
                        <div className="nb-overlay" onClick={(e) => { if (e.target === e.currentTarget) { setShowAddModal(false); setAddType(''); resetNewItem(); } }}>
                            <div className="nb-modal">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold">Ajouter</h3>
                                    <button onClick={() => { setShowAddModal(false); setAddType(''); resetNewItem(); }} className="text-[var(--text-soft)]"><Icon name="x" size={22} /></button>
                                </div>
                                {!addType ? (
                                    <div className="space-y-2">
                                        {[
                                            { type: 'event', label: 'Ã‰vÃ©nement', icon: 'calendar', bg: 'bg-[var(--card)] hover:bg-[var(--bg)]' },
                                            { type: 'todo', label: 'TÃ¢che', icon: 'check', bg: 'bg-green-50 hover:bg-green-100' },
                                            { type: 'course', label: 'Course', icon: 'cart', bg: 'bg-orange-50 hover:bg-orange-100' },
                                            { type: 'menu', label: 'Menu', icon: 'chef', bg: 'bg-[var(--card)] hover:bg-[var(--bg)]' },
                                        ].map(opt => (
                                            <button key={opt.type} onClick={() => setAddType(opt.type)} className={`w-full ${opt.bg} p-4 rounded-2xl text-left flex items-center gap-3`}>
                                                {React.createElement(Icon, {name: opt.icon, size:28, color:'var(--text)'})}<span className="font-semibold">{opt.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        <input type="text" placeholder={addType === 'course' ? 'Article' : addType === 'menu' ? 'Plat' : 'Titre'} value={newItem.title} onChange={(e) => setNewItem({ ...newItem, title: e.target.value })} className="w-full nb-input" autoFocus onKeyDown={(e) => { if (e.key === 'Enter') handleAdd(); }} />
                                        
                                        {addType === 'menu' && (
                                            <select value={newItem.day} onChange={(e) => setNewItem({ ...newItem, day: e.target.value })} className="w-full nb-input">
                                                <option value="">Jour</option>
                                                {DAY_ORDER.map(d => <option key={d} value={d}>{d}</option>)}
                                            </select>
                                        )}
                                        
                                        {addType === 'event' && (
                                            <>
                                                {/* Period toggle */}
                                                <div className="flex gap-2 bg-gray-100 p-1 rounded-xl">
                                                    <button onClick={() => setNewItem({ ...newItem, isPeriod: false, endDate: '' })} className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all ${!newItem.isPeriod ? 'bg-[var(--card)] shadow text-[var(--text)]' : 'text-[var(--text-soft)]'}`}>{React.createElement(Icon, {name:"star", size:12})} Ponctuel</button>
                                                    <button onClick={() => setNewItem({ ...newItem, isPeriod: true, time: '' })} className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all ${newItem.isPeriod ? 'bg-[var(--card)] shadow text-[var(--text)]' : 'text-[var(--text-soft)]'}`}>{React.createElement(Icon, {name:"calendar", size:12})} PÃ©riode</button>
                                                </div>
                                                <div className="flex gap-2">
                                                    <div className="flex-1">
                                                        <label className="text-xs text-[var(--text-soft)] mb-1 block">{newItem.isPeriod ? 'DÃ©but' : 'Date'}</label>
                                                        <input type="date" value={newItem.date} onChange={(e) => setNewItem({ ...newItem, date: e.target.value })} className="w-full nb-input" />
                                                    </div>
                                                    {newItem.isPeriod && (
                                                        <div className="flex-1">
                                                            <label className="text-xs text-[var(--text-soft)] mb-1 block">Fin</label>
                                                            <input type="date" value={newItem.endDate} min={newItem.date} onChange={(e) => setNewItem({ ...newItem, endDate: e.target.value })} className="w-full nb-input" />
                                                        </div>
                                                    )}
                                                </div>
                                                {!newItem.isPeriod && (
                                                    <input type="time" value={newItem.time} onChange={(e) => setNewItem({ ...newItem, time: e.target.value })} className="w-full nb-input" />
                                                )}
                                                <select value={newItem.category} onChange={(e) => setNewItem({ ...newItem, category: e.target.value })} className="w-full nb-select">
                                                    <option value="">CatÃ©gorie</option>
                                                    {categories.events.map(c => <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>)}
                                                </select>
                                                {/* Color picker */}
                                                <div>
                                                    <p className="text-xs font-semibold mb-1.5" style={{color:'var(--text-soft)'}}>Couleur</p>
                                                    <div className="flex gap-2 flex-wrap">
                                                        <button type="button" onClick={() => setNewItem({...newItem, color: ''})} className="cdot" style={{background: newItem.color ? 'var(--card)' : 'var(--text)', borderWidth: !newItem.color ? '3px' : '2px'}} title="Aucune"></button>
                                                        {EVENT_COLORS.map(c => (
                                                            <button type="button" key={c.id} onClick={() => setNewItem({...newItem, color: c.id})} className="cdot" style={{background: c.hex, borderWidth: newItem.color === c.id ? '3px' : '2px', transform: newItem.color === c.id ? 'scale(1.2)' : 'scale(1)', transition: 'transform 0.1s'}} title={c.name}></button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                        
                                        {addType === 'todo' && (
                                            <>
                                                <select value={newItem.category} onChange={(e) => setNewItem({ ...newItem, category: e.target.value })} className="w-full nb-input">
                                                    <option value="">CatÃ©gorie</option>
                                                    {categories.todos.map(c => <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>)}
                                                </select>
                                                <select value={newItem.priority} onChange={(e) => setNewItem({ ...newItem, priority: e.target.value })} className="w-full nb-input">
                                                    <option value="low">âšª Basse</option>
                                                    <option value="medium">â— Moyenne</option>
                                                    <option value="high">â— Haute</option>
                                                </select>
                                                <select value={newItem.assignedTo || ''} onChange={(e) => setNewItem({ ...newItem, assignedTo: e.target.value ? parseInt(e.target.value) : null })} className="w-full nb-input">
                                                    <option value="">â“ Non assignÃ©</option>
                                                    {users.map(u => <option key={u.id} value={u.id}>{u.emoji} {u.name}</option>)}
                                                </select>
                                            </>
                                        )}
                                        
                                        {addType === 'course' && (
                                            <select value={newItem.category} onChange={(e) => setNewItem({ ...newItem, category: e.target.value })} className="w-full nb-input">
                                                {categories.courses.map(c => <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>)}
                                            </select>
                                        )}
                                        
                                        <div className="flex gap-3 mt-2">
                                            <button onClick={() => { setAddType(''); resetNewItem(); }} className="flex-1 nb-btn py-3 text-sm" style={{background:"var(--card)"}}>Retour</button>
                                            <button onClick={handleAdd} className="flex-1 nb-btn py-3 text-sm" style={{background:"var(--turquoise)", color:"white"}}>Ajouter</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* ===== CATEGORY MODAL (emoji picker) ===== */}
                    {addCategoryModal && (
                        <div className="nb-overlay" onClick={(e) => { if (e.target === e.currentTarget) { setAddCategoryModal(null); setNewCatName(''); setNewCatEmoji(''); } }}>
                            <div className="nb-modal">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="text-lg font-bold">Nouvelle catÃ©gorie</h3>
                                    <button onClick={() => { setAddCategoryModal(null); setNewCatName(''); setNewCatEmoji(''); }} className="text-[var(--text-soft)]"><Icon name="x" size={20} /></button>
                                </div>
                                <input type="text" placeholder="Nom de la catÃ©gorie" value={newCatName} onChange={(e) => setNewCatName(e.target.value)} className="w-full px-4 py-3 border-2 rounded-xl mb-3 text-sm" autoFocus />
                                <p className="text-xs text-[var(--text-soft)] mb-2">Choisir un emoji :</p>
                                <div className="grid grid-cols-8 gap-1.5 mb-3 max-h-36 overflow-y-auto p-1">
                                    {EMOJI_PICKER.map(em => (
                                        <button key={em} onClick={() => setNewCatEmoji(em)} className={`text-xl p-1.5 rounded-lg hover:bg-[var(--card)] transition-all ${newCatEmoji === em ? 'bg-[var(--bg)] ring-2 ring-[var(--turquoise)] scale-110' : ''}`}>{em}</button>
                                    ))}
                                </div>
                                {newCatEmoji && newCatName.trim() && (
                                    <div className="flex items-center gap-2 bg-[var(--card)] rounded-xl p-3 mb-3">
                                        <span className="text-xl">{newCatEmoji}</span><span className="font-medium text-sm">{newCatName}</span>
                                    </div>
                                )}
                                <div className="flex gap-3">
                                    <button onClick={() => { setAddCategoryModal(null); setNewCatName(''); setNewCatEmoji(''); }} className="flex-1 nb-btn py-3 text-sm" style={{background:"var(--card)"}}>Annuler</button>
                                    <button onClick={handleAddCategory} disabled={!newCatName.trim() || !newCatEmoji} className={`flex-1 py-3 rounded-xl text-sm font-medium transition-all ${newCatName.trim() && newCatEmoji ? 'bg-[var(--turquoise)] text-[var(--text)] font-bold' : 'bg-gray-200 text-[var(--text-soft)]'}`}>Ajouter</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ===== ASSIGN PICKER (replaces prompt) ===== */}
                    {assignPickerTodo && (
                        <div className="nb-overlay">
                            <div className="nb-modal" style={{maxWidth:"360px"}}>
                                <h3 className="text-lg font-bold mb-3">Qui a fait cette tÃ¢che ?</h3>
                                <div className="space-y-2">
                                    {users.map(u => (
                                        <button key={u.id} onClick={() => confirmAssignTodo(assignPickerTodo, u.id)} className={`w-full ${u.color} text-white p-4 rounded-2xl flex items-center justify-center gap-3 hover:opacity-90`}>
                                            {React.createElement(AvatarSVG, {shape: u.shape, color: 'rgba(255,255,255,0.85)', size: 32})}<span className="font-bold">{u.name}</span>
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => setAssignPickerTodo(null)} className="w-full bg-gray-100 py-3 rounded-xl mt-3 text-sm">Annuler</button>
                            </div>
                        </div>
                    )}

                    {/* ===== ADD EXTERNAL PERSON MODAL ===== */}
                    {addPersonModal && (
                        <div className="nb-overlay" onClick={(e) => { if (e.target === e.currentTarget) setAddPersonModal(false); }}>
                            <div className="nb-modal">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="text-lg font-bold">Ajouter une personne</h3>
                                    <button onClick={() => setAddPersonModal(false)} className="text-[var(--text-soft)]"><Icon name="x" size={20} /></button>
                                </div>
                                <input type="text" placeholder="Nom" value={newPersonName} onChange={(e) => setNewPersonName(e.target.value)} className="w-full px-4 py-3 border-2 rounded-xl mb-3 text-sm" autoFocus />
                                <p className="text-xs text-[var(--text-soft)] mb-2">Choisir un emoji :</p>
                                <div className="grid grid-cols-8 gap-1.5 mb-3 max-h-36 overflow-y-auto p-1">
                                    {['ðŸ‘µ','ðŸ‘´','ðŸ§‘â€ðŸ¼','ðŸ‘©â€ðŸ«','ðŸ‘¨â€âš•ï¸','ðŸ‘©â€âš•ï¸','ðŸ§‘','ðŸ‘§','ðŸ‘¦','ðŸ§“','ðŸ‘©â€ðŸ¦°','ðŸ‘¨â€ðŸ¦±','ðŸ§‘â€ðŸ¤â€ðŸ§‘','ðŸ‘«','ðŸ§’','ðŸ‘¶'].map(em => (
                                        <button key={em} onClick={() => setNewPersonEmoji(em)} className={`text-xl p-1.5 rounded-lg hover:bg-[var(--card)] transition-all ${newPersonEmoji === em ? 'bg-[var(--bg)] ring-2 ring-[var(--turquoise)] scale-110' : ''}`}>{em}</button>
                                    ))}
                                </div>
                                {newPersonEmoji && newPersonName.trim() && (
                                    <div className="flex items-center gap-2 bg-[var(--card)] rounded-xl p-3 mb-3">
                                        <span className="text-xl">{newPersonEmoji}</span><span className="font-medium text-sm">{newPersonName}</span>
                                    </div>
                                )}
                                <div className="flex gap-3">
                                    <button onClick={() => setAddPersonModal(false)} className="flex-1 nb-btn py-3 text-sm" style={{background:"var(--card)"}}>Annuler</button>
                                    <button onClick={() => {
                                        if (newPersonName.trim() && newPersonEmoji) {
                                            const maxId = Math.max(...externalPeople.map(p => p.id), ...users.map(u => u.id));
                                            setExternalPeople([...externalPeople, { id: maxId + 1, name: newPersonName.trim(), emoji: newPersonEmoji }]);
                                            setAddPersonModal(false);
                                        }
                                    }} disabled={!newPersonName.trim() || !newPersonEmoji} className={`flex-1 py-3 rounded-xl text-sm font-medium transition-all ${newPersonName.trim() && newPersonEmoji ? 'bg-[var(--turquoise)] text-[var(--text)] font-bold' : 'bg-gray-200 text-[var(--text-soft)]'}`}>Ajouter</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ===== EDIT TODO MODAL ===== */}
                    {editingTodo && (
                        <div className="nb-overlay" onClick={(e) => { if (e.target === e.currentTarget) setEditingTodo(null); }}>
                            <div className="nb-modal">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="text-lg font-bold text-[var(--text)]">Modifier la tÃ¢che</h3>
                                    <button onClick={() => setEditingTodo(null)} className="text-[var(--text-soft)]"><Icon name="x" size={20} /></button>
                                </div>
                                <input type="text" value={editingTodo.title} onChange={(e) => setEditingTodo({...editingTodo, title: e.target.value})} className="w-full px-4 py-3 border-2 border-[var(--border)] rounded-xl mb-3 text-sm" autoFocus />
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label className="text-xs text-[var(--text-soft)] mb-1 block">PrioritÃ©</label>
                                        <select value={editingTodo.priority || ''} onChange={(e) => setEditingTodo({...editingTodo, priority: e.target.value})} className="w-full px-3 py-2 border-2 border-[var(--border)] rounded-xl text-sm">
                                            <option value="">Normale</option>
                                            <option value="medium">â— Moyenne</option>
                                            <option value="high">â— Haute</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs text-[var(--text-soft)] mb-1 block">AssignÃ© Ã </label>
                                        <select value={editingTodo.assignedTo || ''} onChange={(e) => setEditingTodo({...editingTodo, assignedTo: e.target.value ? parseInt(e.target.value) : ''})} className="w-full px-3 py-2 border-2 border-[var(--border)] rounded-xl text-sm">
                                            <option value="">Non assignÃ©</option>
                                            {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setEditingTodo(null)} className="flex-1 nb-btn py-3 text-sm" style={{background:"var(--card)"}}>Annuler</button>
                                    <button onClick={saveTodoEdit} className="flex-1 bg-[var(--turquoise)] text-[var(--text)] font-bold py-3 rounded-xl text-sm">Enregistrer</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ===== EDIT EVENT MODAL ===== */}
                    {editingEvent && (
                        <div className="nb-overlay" onClick={(e) => { if (e.target === e.currentTarget) setEditingEvent(null); }}>
                            <div className="nb-modal">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-heading text-lg font-bold" style={{color:'var(--text)'}}>Modifier l'Ã©vÃ©nement</h3>
                                    <button onClick={() => setEditingEvent(null)} style={{color:'var(--text-soft)'}}><Icon name="x" size={20} /></button>
                                </div>
                                <div className="space-y-3">
                                    <input type="text" value={editingEvent.title} onChange={(e) => setEditingEvent({...editingEvent, title: e.target.value})} className="w-full nb-input" placeholder="Titre" />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="date" value={editingEvent.date} onChange={(e) => setEditingEvent({...editingEvent, date: e.target.value})} className="nb-input" />
                                        <input type="time" value={editingEvent.time || ''} onChange={(e) => setEditingEvent({...editingEvent, time: e.target.value})} className="nb-input" />
                                    </div>
                                    {editingEvent.endDate !== undefined && (
                                        <div>
                                            <label className="text-xs font-semibold" style={{color:'var(--text-soft)'}}>Date de fin (pÃ©riode)</label>
                                            <input type="date" value={editingEvent.endDate || ''} onChange={(e) => setEditingEvent({...editingEvent, endDate: e.target.value})} className="w-full nb-input mt-1" />
                                        </div>
                                    )}
                                    <select value={editingEvent.category || ''} onChange={(e) => setEditingEvent({...editingEvent, category: e.target.value})} className="w-full nb-select">
                                        <option value="">CatÃ©gorie...</option>
                                        {categories.events.map(c => <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>)}
                                    </select>
                                    {/* Color picker */}
                                    <div>
                                        <p className="text-xs font-semibold mb-1.5" style={{color:'var(--text-soft)'}}>Couleur</p>
                                        <div className="flex gap-2 flex-wrap">
                                            <button onClick={() => setEditingEvent({...editingEvent, color: ''})} className="cdot" style={{background: editingEvent.color ? 'var(--card)' : 'var(--text)', borderWidth: !editingEvent.color ? '3px' : '2px'}} title="Aucune"></button>
                                            {EVENT_COLORS.map(c => (
                                                <button key={c.id} onClick={() => setEditingEvent({...editingEvent, color: c.id})} className="cdot" style={{background: c.hex, borderWidth: editingEvent.color === c.id ? '3px' : '2px', transform: editingEvent.color === c.id ? 'scale(1.2)' : 'scale(1)'}} title={c.name}></button>
                                            ))}
                                        </div>
                                    </div>
                                    {editingEvent.calendarEventId && (
                                        <p className="text-xs flex items-center gap-1" style={{color:'var(--green)'}}><Icon name="cloud" size={12} /> LiÃ© Ã  Google Calendar</p>
                                    )}
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setEditingEvent(null)} className="flex-1 nb-btn py-2.5 text-sm" style={{background:'var(--card)'}}>Annuler</button>
                                    <button onClick={saveEventEdit} className="flex-1 nb-btn py-2.5 text-sm" style={{background:'var(--turquoise)', color:'white'}}>
                                        <Icon name="save" size={16} /> Sauvegarder
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ===== CALENDAR PICKER MODAL ===== */}
                    {showCalendarPicker && (
                        <div className="nb-overlay" onClick={(e) => { if (e.target === e.currentTarget) setShowCalendarPicker(false); }}>
                            <div className="nb-modal">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="text-lg font-bold text-[var(--text)]">Choisir un calendrier</h3>
                                    <button onClick={() => setShowCalendarPicker(false)} className="text-[var(--text-soft)]"><Icon name="x" size={20} /></button>
                                </div>
                                <p className="text-xs text-[var(--text-soft)] mb-3">SÃ©lectionne le calendrier Ã  utiliser pour Ratours. Ce choix sera partagÃ© avec tous les utilisateurs.</p>
                                <div className="space-y-2">
                                    {availableCalendars.map(cal => (
                                        <button key={cal.id} onClick={() => selectCalendar(cal.id, cal.name)} className="w-full text-left p-3 rounded-xl border-2 border-[var(--border)] hover:border-[var(--turquoise)] hover:bg-[var(--card)] transition-all">
                                            <div className="font-medium text-sm text-[var(--text)] flex items-center gap-1">{React.createElement(Icon, {name:"calendar", size:14})} {cal.name}</div>
                                            <div className="text-[10px] text-[var(--text-soft)] truncate mt-0.5">{cal.id}</div>
                                        </button>
                                    ))}
                                </div>
                                {availableCalendars.length === 0 && <p className="text-center text-[var(--text-soft)] text-sm py-4">Aucun calendrier trouvÃ©</p>}
                            </div>
                        </div>
                    )}

                    {/* ===== NAV BAR (2 rows of 5) ===== */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-[var(--card)] border-t border-[var(--border)] shadow-lg z-50 safe-bottom">
                        <div className="max-w-4xl mx-auto px-1 py-0.5">
                            <div className="grid grid-cols-5 gap-0.5">
                                {[
                                    { id: 'dashboard', label: 'Accueil', icon: 'home' },
                                    { id: 'calendar', label: 'Agenda', icon: 'calendar' },
                                    { id: 'todos', label: 'TÃ¢ches', icon: 'check' },
                                    { id: 'courses', label: 'Courses', icon: 'cart' },
                                    { id: 'menus', label: 'Menus', icon: 'chef' },
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`nav-tab flex flex-col items-center py-2 ${activeTab === tab.id ? 'active' : ''}`} style={{color: activeTab === tab.id ? 'var(--text)' : 'var(--text-soft)'}}>
                                        <Icon name={tab.icon} size={18} />
                                        <span className="text-[9px] leading-tight mt-0.5">{tab.label}</span>
                                    </button>
                                ))}
                            </div>
                            <div className="grid grid-cols-5 gap-0.5">
                                {[
                                    { id: 'stats', label: 'Stats', icon: 'chart' },
                                    { id: 'guard', label: 'Garde', icon: 'baby' },
                                    { id: 'notes', label: 'Notes', icon: 'notes' },
                                    { id: 'family', label: 'Infos', icon: 'users' },
                                    { id: 'settings', label: 'RÃ©glages', icon: 'settings' },
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`nav-tab flex flex-col items-center py-2 ${activeTab === tab.id ? 'active' : ''}`} style={{color: activeTab === tab.id ? 'var(--text)' : 'var(--text-soft)'}}>
                                        <Icon name={tab.icon} size={18} />
                                        <span className="text-[9px] leading-tight mt-0.5">{tab.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
