<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme Ratours</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const GOOGLE_CLIENT_ID = '988519105715-eqfihmrhgotpkund2ub9nvb3ov7nfde4.apps.googleusercontent.com';
        const SPREADSHEET_ID = '186a_JILQOYaF52HWNWunctYmriWTYaRIo4rlDscixcw';
        
        const Icon = ({ name, size = 24 }) => {
            const icons = {
                home: "üè†", calendar: "üìÖ", check: "‚úì", cart: "üõí",
                chef: "üçΩÔ∏è", users: "üë®‚Äçüë©‚Äçüëß", logout: "‚Üí", settings: "‚öôÔ∏è",
                chart: "üìä", baby: "üë∂", plus: "+", x: "√ó",
                edit: "‚úèÔ∏è", save: "üíæ", trash: "üóëÔ∏è", cloud: "‚òÅÔ∏è", sync: "üîÑ"
            };
            return <span style={{ fontSize: size }}>{icons[name] || "‚Ä¢"}</span>;
        };

        class GoogleSheetsService {
            constructor() {
                this.accessToken = null;
                this.tokenClient = null;
                this.spreadsheetId = SPREADSHEET_ID;
            }

            initialize() {
                return new Promise((resolve) => {
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/spreadsheets',
                        callback: (response) => {
                            if (response.access_token) {
                                this.accessToken = response.access_token;
                                localStorage.setItem('gsheets_token', response.access_token);
                                localStorage.setItem('gsheets_token_time', Date.now().toString());
                            }
                        },
                    });
                    const savedToken = localStorage.getItem('gsheets_token');
                    const tokenTime = localStorage.getItem('gsheets_token_time');
                    // V√©rifier si le token a moins d'1 heure
                    if (savedToken && tokenTime && (Date.now() - parseInt(tokenTime)) < 3600000) {
                        this.accessToken = savedToken;
                    } else {
                        // Token expir√©, le supprimer
                        localStorage.removeItem('gsheets_token');
                        localStorage.removeItem('gsheets_token_time');
                    }
                    resolve(true);
                });
            }

            async requestAuth() {
                return new Promise((resolve) => {
                    this.tokenClient.callback = (response) => {
                        if (response.access_token) {
                            this.accessToken = response.access_token;
                            localStorage.setItem('gsheets_token', response.access_token);
                            localStorage.setItem('gsheets_token_time', Date.now().toString());
                            resolve(true);
                        } else resolve(false);
                    };
                    this.tokenClient.requestAccessToken();
                });
            }

            isAuthenticated() { 
                const tokenTime = localStorage.getItem('gsheets_token_time');
                if (!this.accessToken || !tokenTime) return false;
                // V√©rifier si le token n'est pas expir√© (1 heure)
                return (Date.now() - parseInt(tokenTime)) < 3600000;
            }
            
            hasSpreadsheet() { return !!this.spreadsheetId; }

            logout() {
                this.accessToken = null;
                localStorage.removeItem('gsheets_token');
                localStorage.removeItem('gsheets_token_time');
            }

            async readSheet(sheetName) {
                try {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}/values/${sheetName}!A:Z`;
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    if (!response.ok) {
                        console.error(`Erreur ${response.status} lecture ${sheetName}`);
                        if (response.status === 401) {
                            this.logout(); // Token invalide
                        }
                        return [];
                    }
                    const result = await response.json();
                    return result.values || [];
                } catch (error) {
                    console.error(`Erreur lecture ${sheetName}:`, error);
                    return [];
                }
            }

            async writeSheet(sheetName, values) {
                try {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}/values/${sheetName}!A:Z?valueInputOption=RAW`;
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ values })
                    });
                    if (!response.ok) {
                        console.error(`Erreur ${response.status} √©criture ${sheetName}`);
                        if (response.status === 401) {
                            this.logout(); // Token invalide
                        }
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error(`Erreur √©criture ${sheetName}:`, error);
                    return false;
                }
            }

            arrayToObjects(array) {
                if (!array || array.length === 0) return [];
                const headers = array[0];
                return array.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => { obj[header] = row[index] || ''; });
                    return obj;
                });
            }

            objectsToArray(objects, headers) {
                if (!objects || objects.length === 0) return [headers];
                const rows = objects.map(obj => headers.map(header => obj[header] !== undefined ? String(obj[header]) : ''));
                return [headers, ...rows];
            }
        }

        const gsheets = new GoogleSheetsService();

        const App = () => {
            const [isGoogleReady, setIsGoogleReady] = useState(false);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [showAddModal, setShowAddModal] = useState(false);
            const [addType, setAddType] = useState('');
            const [syncError, setSyncError] = useState(null);
            
            // Utiliser useRef pour √©viter les doubles syncs
            const isSyncingRef = useRef(false);
            const lastSyncDataRef = useRef('');

            const [users] = useState([
                { id: 1, name: 'Maman', color: 'bg-pink-400', emoji: 'üë©' },
                { id: 2, name: 'Papa', color: 'bg-blue-400', emoji: 'üë®' },
            ]);

            const [categories] = useState({
                courses: [
                    { id: 'alimentaire', name: 'Alimentaire', emoji: 'ü•ñ' },
                    { id: 'enfant', name: 'Enfant', emoji: 'üçº' },
                    { id: 'maison', name: 'Maison', emoji: 'üßπ' },
                ],
                todos: [
                    { id: 'rdv', name: 'RDV', emoji: 'üìû' },
                    { id: 'enfant', name: 'Enfant', emoji: 'üë∂' },
                    { id: 'maison', name: 'Maison', emoji: 'üè†' },
                ]
            });

            const [todos, setTodos] = useState([]);
            const [courses, setCourses] = useState([]);
            const [menus, setMenus] = useState([]);

            const [newItem, setNewItem] = useState({
                title: '', category: '', priority: 'medium', assignedTo: null, day: ''
            });

            useEffect(() => {
                const initGoogle = async () => {
                    await gsheets.initialize();
                    setIsGoogleReady(true);
                    const isAuth = gsheets.isAuthenticated();
                    setIsAuthenticated(isAuth);
                    console.log('üîê √âtat auth:', isAuth);
                };
                if (window.google) {
                    initGoogle();
                } else {
                    const checkGoogle = setInterval(() => {
                        if (window.google) {
                            clearInterval(checkGoogle);
                            initGoogle();
                        }
                    }, 100);
                }
            }, []);

            const syncFromCloud = async () => {
                if (!isAuthenticated || !gsheets.isAuthenticated()) {
                    console.log('‚ùå Pas authentifi√©, impossible de charger');
                    setIsAuthenticated(false);
                    return;
                }
                
                console.log('üì• Chargement depuis Google Sheets...');
                setIsSyncing(true);
                setSyncError(null);
                
                try {
                    const todosData = await gsheets.readSheet('todos');
                    if (todosData.length > 1) {
                        const loadedTodos = gsheets.arrayToObjects(todosData).map(t => ({
                            ...t, 
                            id: parseInt(t.id), 
                            assignedTo: t.assignedTo ? parseInt(t.assignedTo) : null, 
                            done: t.done === 'true'
                        }));
                        setTodos(loadedTodos);
                        console.log('‚úÖ T√¢ches charg√©es:', loadedTodos.length);
                    } else {
                        setTodos([]);
                    }
                    
                    const coursesData = await gsheets.readSheet('courses');
                    if (coursesData.length > 1) {
                        const loadedCourses = gsheets.arrayToObjects(coursesData).map(c => ({
                            ...c, id: parseInt(c.id), checked: c.checked === 'true'
                        }));
                        setCourses(loadedCourses);
                        console.log('‚úÖ Courses charg√©es:', loadedCourses.length);
                    } else {
                        setCourses([]);
                    }
                    
                    const menusData = await gsheets.readSheet('menus');
                    if (menusData.length > 1) {
                        const loadedMenus = gsheets.arrayToObjects(menusData).map(m => ({
                            ...m, id: parseInt(m.id)
                        }));
                        setMenus(loadedMenus);
                        console.log('‚úÖ Menus charg√©s:', loadedMenus.length);
                    } else {
                        setMenus([]);
                    }
                    
                    setLastSync(new Date());
                    console.log('‚úÖ Chargement termin√©');
                } catch (error) {
                    console.error('‚ùå Erreur chargement:', error);
                    setSyncError('Erreur de chargement');
                    setIsAuthenticated(false);
                }
                
                setIsSyncing(false);
            };

            const syncToCloud = async (force = false) => {
                if (!isAuthenticated || !gsheets.isAuthenticated()) {
                    console.log('‚ùå Pas authentifi√©, impossible de sauvegarder');
                    setIsAuthenticated(false);
                    return false;
                }
                
                // √âviter les doubles syncs
                if (isSyncingRef.current && !force) {
                    console.log('‚è∏Ô∏è Sync d√©j√† en cours, ignor√©e');
                    return false;
                }
                
                // V√©rifier si les donn√©es ont chang√©
                const currentData = JSON.stringify({ todos, courses, menus });
                if (currentData === lastSyncDataRef.current && !force) {
                    console.log('‚è∏Ô∏è Aucun changement, sync ignor√©e');
                    return false;
                }
                
                isSyncingRef.current = true;
                console.log('üíæ Sauvegarde vers Google Sheets...');
                setIsSyncing(true);
                setSyncError(null);
                
                try {
                    const success1 = await gsheets.writeSheet('todos', gsheets.objectsToArray(todos, ['id', 'title', 'category', 'priority', 'done', 'assignedTo']));
                    const success2 = await gsheets.writeSheet('courses', gsheets.objectsToArray(courses, ['id', 'item', 'category', 'checked']));
                    const success3 = await gsheets.writeSheet('menus', gsheets.objectsToArray(menus, ['id', 'day', 'meal', 'emoji']));
                    
                    if (success1 && success2 && success3) {
                        lastSyncDataRef.current = currentData;
                        setLastSync(new Date());
                        console.log('‚úÖ Sauvegarde OK');
                        isSyncingRef.current = false;
                        setIsSyncing(false);
                        return true;
                    } else {
                        console.error('‚ùå Erreur lors de la sauvegarde');
                        setSyncError('Erreur de sauvegarde');
                        setIsAuthenticated(false);
                        isSyncingRef.current = false;
                        setIsSyncing(false);
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå Erreur sauvegarde:', error);
                    setSyncError('Erreur de sauvegarde');
                    setIsAuthenticated(false);
                    isSyncingRef.current = false;
                    setIsSyncing(false);
                    return false;
                }
            };

            const handleGoogleLogin = async () => {
                const success = await gsheets.requestAuth();
                if (success) {
                    setIsAuthenticated(true);
                    await syncFromCloud();
                }
            };
            
            const handleGoogleLogout = () => {
                if (confirm('Se d√©connecter de Google ? Les donn√©es non sauvegard√©es seront perdues.')) {
                    gsheets.logout();
                    setIsAuthenticated(false);
                    setCurrentUser(null);
                    console.log('üîì D√©connect√© de Google');
                }
            };

            // Charger les donn√©es quand currentUser est d√©fini
            useEffect(() => {
                if (isAuthenticated && currentUser && gsheets.hasSpreadsheet()) {
                    console.log('üë§ Utilisateur connect√©, chargement...');
                    syncFromCloud();
                }
            }, [currentUser]);

            // Auto-save apr√®s changements (avec d√©lai)
            useEffect(() => {
                if (isAuthenticated && currentUser) {
                    const timer = setTimeout(() => {
                        syncToCloud();
                    }, 2000);
                    return () => clearTimeout(timer);
                }
            }, [todos, courses, menus, isAuthenticated, currentUser]);

            const handleAdd = () => {
                if (addType === 'todo' && newItem.title) {
                    setTodos([...todos, {
                        id: Date.now(), 
                        title: newItem.title, 
                        category: newItem.category || 'general',
                        priority: newItem.priority, 
                        done: false, 
                        assignedTo: newItem.assignedTo || null
                    }]);
                    setShowAddModal(false);
                    setNewItem({ title: '', category: '', priority: 'medium', assignedTo: null, day: '' });
                } else if (addType === 'course' && newItem.title) {
                    setCourses([...courses, {
                        id: Date.now(), 
                        item: newItem.title, 
                        category: newItem.category || 'alimentaire', 
                        checked: false
                    }]);
                    // Mode ajout rapide pour les courses
                    setNewItem({ ...newItem, title: '' });
                } else if (addType === 'menu' && newItem.title && newItem.day) {
                    setMenus([...menus, { 
                        id: Date.now(), 
                        day: newItem.day, 
                        meal: newItem.title, 
                        emoji: 'üçΩÔ∏è' 
                    }]);
                    setShowAddModal(false);
                    setNewItem({ title: '', category: '', priority: 'medium', assignedTo: null, day: '' });
                }
            };

            const toggleTodo = async (id) => {
                const todo = todos.find(t => t.id === id);
                if (!todo) return;
                
                if (!todo.done && !todo.assignedTo) {
                    const who = prompt(`Qui a fait cette t√¢che ?\n1 - ${users[0].name}\n2 - ${users[1].name}`);
                    if (who === '1' || who === '2') {
                        setTodos(todos.map(t => t.id === id ? { ...t, done: true, assignedTo: parseInt(who) } : t));
                        setTimeout(() => syncToCloud(true), 300);
                    }
                } else {
                    setTodos(todos.map(t => t.id === id ? { ...t, done: !t.done } : t));
                    setTimeout(() => syncToCloud(true), 300);
                }
            };
            
            const toggleCourse = async (id) => {
                setCourses(courses.map(c => c.id === id ? { ...c, checked: !c.checked } : c));
                setTimeout(() => syncToCloud(true), 300);
            };
            
            const deleteTodo = async (id) => {
                if (confirm('Supprimer cette t√¢che ?')) {
                    console.log('üóëÔ∏è Suppression t√¢che:', id);
                    setTodos(todos.filter(t => t.id !== id));
                    setTimeout(async () => {
                        const success = await syncToCloud(true);
                        if (success) {
                            console.log('‚úÖ T√¢che supprim√©e et synchronis√©e');
                        } else {
                            alert('‚ö†Ô∏è Erreur de synchronisation. Reconnectez-vous.');
                        }
                    }, 300);
                }
            };
            
            const deleteCourse = async (id) => {
                if (confirm('Supprimer cet article ?')) {
                    console.log('üóëÔ∏è Suppression course:', id);
                    setCourses(courses.filter(c => c.id !== id));
                    setTimeout(async () => {
                        const success = await syncToCloud(true);
                        if (success) {
                            console.log('‚úÖ Course supprim√©e et synchronis√©e');
                        }
                    }, 300);
                }
            };
            
            const deleteMenu = async (id) => {
                if (confirm('Supprimer ce menu ?')) {
                    console.log('üóëÔ∏è Suppression menu:', id);
                    setMenus(menus.filter(m => m.id !== id));
                    setTimeout(async () => {
                        const success = await syncToCloud(true);
                        if (success) {
                            console.log('‚úÖ Menu supprim√© et synchronis√©');
                        }
                    }, 300);
                }
            };

            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 flex items-center justify-center p-6">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">üè†</div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Plateforme Ratours</h1>
                                <p className="text-gray-600">Qui se connecte ?</p>
                            </div>
                            {isGoogleReady && !isAuthenticated && (
                                <div className="mb-6 p-4 bg-blue-50 rounded-2xl border-2 border-blue-200">
                                    <p className="text-sm text-blue-800 mb-3">‚òÅÔ∏è Connectez-vous pour synchroniser</p>
                                    <button onClick={handleGoogleLogin} className="w-full bg-white border-2 border-gray-300 text-gray-700 px-4 py-3 rounded-xl hover:bg-gray-50 flex items-center justify-center gap-2">
                                        <Icon name="cloud" size={20} />
                                        <span className="font-medium">Se connecter avec Google</span>
                                    </button>
                                </div>
                            )}
                            {isAuthenticated && (
                                <div className="mb-6 p-4 bg-green-50 rounded-2xl border-2 border-green-200">
                                    <div className="flex items-center justify-between mb-2">
                                        <p className="text-sm text-green-800">‚úÖ Connect√© √† Google</p>
                                        <button onClick={handleGoogleLogout} className="text-xs text-red-600 hover:underline">D√©connecter</button>
                                    </div>
                                    <a href="https://docs.google.com/spreadsheets/d/186a_JILQOYaF52HWNWunctYmriWTYaRIo4rlDscixcw" target="_blank" className="text-xs text-blue-600">Ouvrir le Sheet ‚Üí</a>
                                </div>
                            )}
                            {syncError && (
                                <div className="mb-6 p-4 bg-red-50 rounded-2xl border-2 border-red-200">
                                    <p className="text-sm text-red-800">‚ö†Ô∏è {syncError}</p>
                                    <button onClick={handleGoogleLogin} className="text-xs text-blue-600 hover:underline mt-2">Reconnecter</button>
                                </div>
                            )}
                            <div className="space-y-4">
                                {users.map(user => (
                                    <button key={user.id} onClick={() => setCurrentUser(user.id)} className={`w-full ${user.color} text-white p-6 rounded-2xl hover:opacity-90 shadow-lg flex items-center justify-center gap-3`} disabled={!isAuthenticated}>
                                        <span className="text-4xl">{user.emoji}</span>
                                        <span className="text-2xl font-bold">{user.name}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            const currentUserData = users.find(u => u.id === currentUser);
            const myTodos = todos.filter(t => !t.done && t.assignedTo === currentUser);
            const urgentTodos = todos.filter(t => !t.done && t.priority === 'high');

            return (
                <div className="min-h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50 pb-24">
                    <div className="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-5 shadow-xl">
                        <div className="flex justify-between max-w-4xl mx-auto">
                            <div>
                                <h1 className="text-2xl font-bold">Plateforme Ratours</h1>
                                <p className="text-purple-100 text-sm">{currentUserData.emoji} {currentUserData.name}</p>
                            </div>
                            <div className="flex gap-2">
                                {isAuthenticated && (
                                    <button onClick={() => syncFromCloud()} disabled={isSyncing} className="bg-white bg-opacity-20 px-4 py-2 rounded-xl flex items-center gap-2">
                                        <Icon name="sync" size={18} className={isSyncing ? 'animate-spin' : ''} />
                                        {lastSync && <span className="text-xs">{lastSync.toLocaleTimeString()}</span>}
                                    </button>
                                )}
                                <button onClick={() => setCurrentUser(null)} className="bg-white bg-opacity-20 px-4 py-2 rounded-xl">
                                    <Icon name="logout" size={18} />
                                </button>
                            </div>
                        </div>
                    </div>

                    {syncError && (
                        <div className="max-w-4xl mx-auto mt-4 px-4">
                            <div className="bg-red-50 border-2 border-red-300 rounded-xl p-4">
                                <p className="text-red-800">‚ö†Ô∏è {syncError}</p>
                                <button onClick={handleGoogleLogin} className="text-blue-600 hover:underline mt-2 text-sm">Reconnecter</button>
                            </div>
                        </div>
                    )}

                    <div className="p-4 max-w-4xl mx-auto">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-r from-purple-400 to-pink-400 rounded-3xl p-6 text-white shadow-lg">
                                    <h2 className="text-3xl font-bold mb-2">Bonjour {currentUserData.name} ! üëã</h2>
                                    <p className="text-purple-100">{new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                </div>
                                
                                {urgentTodos.length > 0 && (
                                    <div className="bg-red-50 border-2 border-red-300 rounded-2xl shadow-lg p-6">
                                        <h3 className="font-bold text-red-700 mb-4 flex items-center gap-2">
                                            <span className="text-2xl">üî¥</span>
                                            <span>URGENT ({urgentTodos.length})</span>
                                        </h3>
                                        {urgentTodos.slice(0, 5).map(todo => (
                                            <div key={todo.id} className="flex items-center gap-3 py-2 bg-white rounded-xl px-3 mb-2">
                                                <input type="checkbox" className="h-5 w-5" onChange={() => toggleTodo(todo.id)} />
                                                <span className="flex-1 font-semibold">{todo.title}</span>
                                                <span className="text-xs text-gray-500">{users.find(u => u.id === todo.assignedTo)?.emoji || '‚ùì'}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                <div className="bg-white rounded-2xl shadow-lg p-6">
                                    <h3 className="font-bold text-gray-800 mb-4">‚úÖ Mes t√¢ches ({myTodos.length})</h3>
                                    {myTodos.slice(0, 5).map(todo => (
                                        <div key={todo.id} className="flex items-center gap-3 py-2">
                                            <input type="checkbox" className="h-5 w-5" onChange={() => toggleTodo(todo.id)} />
                                            <span>{todo.title}</span>
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-white rounded-2xl shadow-lg p-6">
                                    <h3 className="font-bold text-gray-800 mb-4">üõí Courses ({courses.filter(c => !c.checked).length})</h3>
                                    {courses.filter(c => !c.checked).slice(0, 6).map(course => (
                                        <div key={course.id} className="flex items-center gap-3 py-1">
                                            <input type="checkbox" className="h-4 w-4" onChange={() => toggleCourse(course.id)} />
                                            <span className="text-sm">{course.item}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'todos' && (
                            <div className="space-y-4">
                                <h2 className="text-2xl font-bold">‚úÖ T√¢ches</h2>
                                
                                {todos.filter(t => !t.assignedTo).length > 0 && (
                                    <div className="bg-white rounded-2xl shadow-lg p-5 border-2 border-yellow-300">
                                        <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                            <span className="text-2xl">‚ùì</span>
                                            <span>Non assign√©es</span>
                                        </h3>
                                        {todos.filter(t => !t.assignedTo).map(todo => (
                                            <div key={todo.id} className="flex items-center justify-between py-3 border-b last:border-0">
                                                <div className="flex items-center gap-3 flex-1">
                                                    <input type="checkbox" checked={todo.done} onChange={() => toggleTodo(todo.id)} className="h-5 w-5" />
                                                    <span className={todo.done ? 'line-through text-gray-400' : ''}>{todo.title}</span>
                                                </div>
                                                <button onClick={() => deleteTodo(todo.id)} className="text-red-400"><Icon name="x" size={16} /></button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {categories.todos.map(cat => {
                                    const catTodos = todos.filter(t => t.category === cat.id && t.assignedTo);
                                    if (catTodos.length === 0) return null;
                                    return (
                                        <div key={cat.id} className="bg-white rounded-2xl shadow-lg p-5">
                                            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                                <span className="text-2xl">{cat.emoji}</span>
                                                <span>{cat.name}</span>
                                            </h3>
                                            {catTodos.map(todo => (
                                                <div key={todo.id} className="flex items-center justify-between py-3 border-b last:border-0">
                                                    <div className="flex items-center gap-3 flex-1">
                                                        <input type="checkbox" checked={todo.done} onChange={() => toggleTodo(todo.id)} className="h-5 w-5" />
                                                        <span className={todo.done ? 'line-through text-gray-400' : ''}>{todo.title}</span>
                                                    </div>
                                                    <button onClick={() => deleteTodo(todo.id)} className="text-red-400"><Icon name="x" size={16} /></button>
                                                </div>
                                            ))}
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {activeTab === 'courses' && (
                            <div className="space-y-4">
                                <h2 className="text-2xl font-bold">üõí Courses</h2>
                                {categories.courses.map(cat => {
                                    const catCourses = courses.filter(c => c.category === cat.id);
                                    if (catCourses.length === 0) return null;
                                    return (
                                        <div key={cat.id} className="bg-white rounded-2xl shadow-lg p-5">
                                            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                                <span className="text-2xl">{cat.emoji}</span>
                                                <span>{cat.name}</span>
                                            </h3>
                                            {catCourses.map(course => (
                                                <div key={course.id} className="flex items-center justify-between py-2 border-b last:border-0">
                                                    <div className="flex items-center gap-3 flex-1">
                                                        <input type="checkbox" checked={course.checked} onChange={() => toggleCourse(course.id)} className="h-5 w-5" />
                                                        <span className={course.checked ? 'line-through text-gray-400' : ''}>{course.item}</span>
                                                    </div>
                                                    <button onClick={() => deleteCourse(course.id)} className="text-red-400"><Icon name="x" size={16} /></button>
                                                </div>
                                            ))}
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {activeTab === 'menus' && (
                            <div className="space-y-4">
                                <h2 className="text-2xl font-bold">üçΩÔ∏è Menus</h2>
                                {menus.map(m => (
                                    <div key={m.id} className="bg-white rounded-2xl shadow-lg p-5 flex gap-4">
                                        <span className="text-5xl">{m.emoji}</span>
                                        <div className="flex-1">
                                            <h3 className="font-bold text-lg">{m.day}</h3>
                                            <p className="text-gray-600">{m.meal}</p>
                                        </div>
                                        <button onClick={() => deleteMenu(m.id)} className="text-red-400"><Icon name="trash" size={20} /></button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <button onClick={() => setShowAddModal(true)} className="fixed bottom-28 right-6 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full p-5 shadow-2xl hover:scale-110 transition-transform z-40">
                        <Icon name="plus" size={28} />
                    </button>

                    {showAddModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-3xl shadow-2xl max-w-md w-full p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-bold">Ajouter</h3>
                                    <button onClick={() => { setShowAddModal(false); setAddType(''); }} className="text-gray-400">
                                        <Icon name="x" size={28} />
                                    </button>
                                </div>
                                {!addType ? (
                                    <div className="space-y-3">
                                        <button onClick={() => setAddType('todo')} className="w-full bg-green-50 hover:bg-green-100 p-5 rounded-2xl text-left flex items-center gap-3">
                                            <span className="text-3xl">‚úÖ</span><span className="font-semibold text-lg">T√¢che</span>
                                        </button>
                                        <button onClick={() => setAddType('course')} className="w-full bg-orange-50 hover:bg-orange-100 p-5 rounded-2xl text-left flex items-center gap-3">
                                            <span className="text-3xl">üõí</span><span className="font-semibold text-lg">Course</span>
                                        </button>
                                        <button onClick={() => setAddType('menu')} className="w-full bg-purple-50 hover:bg-purple-100 p-5 rounded-2xl text-left flex items-center gap-3">
                                            <span className="text-3xl">üçΩÔ∏è</span><span className="font-semibold text-lg">Menu</span>
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <input type="text" placeholder={addType === 'course' ? 'Article' : addType === 'menu' ? 'Plat' : 'Titre'} value={newItem.title} onChange={(e) => setNewItem({ ...newItem, title: e.target.value })} className="w-full px-4 py-3 border-2 rounded-xl" autoFocus />
                                        {addType === 'menu' && (
                                            <select value={newItem.day} onChange={(e) => setNewItem({ ...newItem, day: e.target.value })} className="w-full px-4 py-3 border-2 rounded-xl">
                                                <option value="">Jour</option>
                                                {['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'].map(d => <option key={d} value={d}>{d}</option>)}
                                            </select>
                                        )}
                                        {addType === 'todo' && (
                                            <>
                                                <select value={newItem.category} onChange={(e) => setNewItem({ ...newItem, category: e.target.value })} className="w-full px-4 py-3 border-2 rounded-xl">
                                                    <option value="">Cat√©gorie</option>
                                                    {categories.todos.map(c => <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>)}
                                                </select>
                                                <select value={newItem.priority} onChange={(e) => setNewItem({ ...newItem, priority: e.target.value })} className="w-full px-4 py-3 border-2 rounded-xl">
                                                    <option value="low">‚ö™ Basse</option>
                                                    <option value="medium">üü° Moyenne</option>
                                                    <option value="high">üî¥ Haute</option>
                                                </select>
                                                <select value={newItem.assignedTo || ''} onChange={(e) => setNewItem({ ...newItem, assignedTo: e.target.value ? parseInt(e.target.value) : null })} className="w-full px-4 py-3 border-2 rounded-xl">
                                                    <option value="">‚ùì Non assign√©</option>
                                                    {users.map(u => <option key={u.id} value={u.id}>{u.emoji} {u.name}</option>)}
                                                </select>
                                            </>
                                        )}
                                        {addType === 'course' && (
                                            <select value={newItem.category} onChange={(e) => setNewItem({ ...newItem, category: e.target.value })} className="w-full px-4 py-3 border-2 rounded-xl">
                                                {categories.courses.map(c => <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>)}
                                            </select>
                                        )}
                                        <div className="flex gap-3 mt-6">
                                            <button onClick={() => setAddType('')} className="flex-1 bg-gray-100 py-3 rounded-xl">Retour</button>
                                            <button onClick={handleAdd} className="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl">Ajouter</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t-2 shadow-2xl z-50">
                        <div className="max-w-4xl mx-auto px-1 py-2">
                            <div className="grid grid-cols-4 gap-1">
                                {[
                                    { id: 'dashboard', label: 'Accueil', emoji: 'üè†' },
                                    { id: 'todos', label: 'T√¢ches', emoji: '‚úÖ' },
                                    { id: 'courses', label: 'Courses', emoji: 'üõí' },
                                    { id: 'menus', label: 'Menus', emoji: 'üçΩÔ∏è' },
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center py-2 rounded-2xl ${activeTab === tab.id ? 'bg-purple-100 text-purple-600' : 'text-gray-500'}`}>
                                        <span className="text-2xl">{tab.emoji}</span>
                                        <span className="text-xs">{tab.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
